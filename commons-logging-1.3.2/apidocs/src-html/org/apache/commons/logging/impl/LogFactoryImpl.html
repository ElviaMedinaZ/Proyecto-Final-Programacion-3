<!DOCTYPE HTML>
<html lang="en">
<head>
<!-- Generated by javadoc (21) -->
<title>Source code</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="source: package: org.apache.commons.logging.impl, class: LogFactoryImpl">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line-1">/*</span>
<span class="source-line-no">002</span><span id="line-2"> * Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="source-line-no">003</span><span id="line-3"> * contributor license agreements.  See the NOTICE file distributed with</span>
<span class="source-line-no">004</span><span id="line-4"> * this work for additional information regarding copyright ownership.</span>
<span class="source-line-no">005</span><span id="line-5"> * The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="source-line-no">006</span><span id="line-6"> * (the "License"); you may not use this file except in compliance with</span>
<span class="source-line-no">007</span><span id="line-7"> * the License.  You may obtain a copy of the License at</span>
<span class="source-line-no">008</span><span id="line-8"> *</span>
<span class="source-line-no">009</span><span id="line-9"> *      http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="source-line-no">010</span><span id="line-10"> *</span>
<span class="source-line-no">011</span><span id="line-11"> * Unless required by applicable law or agreed to in writing, software</span>
<span class="source-line-no">012</span><span id="line-12"> * distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="source-line-no">013</span><span id="line-13"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="source-line-no">014</span><span id="line-14"> * See the License for the specific language governing permissions and</span>
<span class="source-line-no">015</span><span id="line-15"> * limitations under the License.</span>
<span class="source-line-no">016</span><span id="line-16"> */</span>
<span class="source-line-no">017</span><span id="line-17"></span>
<span class="source-line-no">018</span><span id="line-18">package org.apache.commons.logging.impl;</span>
<span class="source-line-no">019</span><span id="line-19"></span>
<span class="source-line-no">020</span><span id="line-20">import java.io.PrintWriter;</span>
<span class="source-line-no">021</span><span id="line-21">import java.io.StringWriter;</span>
<span class="source-line-no">022</span><span id="line-22">import java.lang.reflect.Constructor;</span>
<span class="source-line-no">023</span><span id="line-23">import java.lang.reflect.InvocationTargetException;</span>
<span class="source-line-no">024</span><span id="line-24">import java.lang.reflect.Method;</span>
<span class="source-line-no">025</span><span id="line-25">import java.net.URL;</span>
<span class="source-line-no">026</span><span id="line-26">import java.security.AccessController;</span>
<span class="source-line-no">027</span><span id="line-27">import java.security.PrivilegedAction;</span>
<span class="source-line-no">028</span><span id="line-28">import java.util.Hashtable;</span>
<span class="source-line-no">029</span><span id="line-29"></span>
<span class="source-line-no">030</span><span id="line-30">import org.apache.commons.logging.Log;</span>
<span class="source-line-no">031</span><span id="line-31">import org.apache.commons.logging.LogConfigurationException;</span>
<span class="source-line-no">032</span><span id="line-32">import org.apache.commons.logging.LogFactory;</span>
<span class="source-line-no">033</span><span id="line-33"></span>
<span class="source-line-no">034</span><span id="line-34">/**</span>
<span class="source-line-no">035</span><span id="line-35"> * Concrete subclass of {@link LogFactory} that implements the</span>
<span class="source-line-no">036</span><span id="line-36"> * following algorithm to dynamically select a logging implementation</span>
<span class="source-line-no">037</span><span id="line-37"> * class to instantiate a wrapper for:</span>
<span class="source-line-no">038</span><span id="line-38"> * &lt;ul&gt;</span>
<span class="source-line-no">039</span><span id="line-39"> * &lt;li&gt;Use a factory configuration attribute named</span>
<span class="source-line-no">040</span><span id="line-40"> *     {@code org.apache.commons.logging.Log} to identify the</span>
<span class="source-line-no">041</span><span id="line-41"> *     requested implementation class.&lt;/li&gt;</span>
<span class="source-line-no">042</span><span id="line-42"> * &lt;li&gt;Use the {@code org.apache.commons.logging.Log} system property</span>
<span class="source-line-no">043</span><span id="line-43"> *     to identify the requested implementation class.&lt;/li&gt;</span>
<span class="source-line-no">044</span><span id="line-44"> * &lt;li&gt;If &lt;em&gt;Log4J&lt;/em&gt; is available, return an instance of</span>
<span class="source-line-no">045</span><span id="line-45"> *     {@code org.apache.commons.logging.impl.Log4JLogger}.&lt;/li&gt;</span>
<span class="source-line-no">046</span><span id="line-46"> * &lt;li&gt;If &lt;em&gt;JDK 1.4 or later&lt;/em&gt; is available, return an instance of</span>
<span class="source-line-no">047</span><span id="line-47"> *     {@code org.apache.commons.logging.impl.Jdk14Logger}.&lt;/li&gt;</span>
<span class="source-line-no">048</span><span id="line-48"> * &lt;li&gt;Otherwise, return an instance of</span>
<span class="source-line-no">049</span><span id="line-49"> *     {@code org.apache.commons.logging.impl.SimpleLog}.&lt;/li&gt;</span>
<span class="source-line-no">050</span><span id="line-50"> * &lt;/ul&gt;</span>
<span class="source-line-no">051</span><span id="line-51"> * &lt;p&gt;</span>
<span class="source-line-no">052</span><span id="line-52"> * If the selected {@link Log} implementation class has a</span>
<span class="source-line-no">053</span><span id="line-53"> * &lt;code&gt;setLogFactory()&lt;/code&gt; method that accepts a {@link LogFactory}</span>
<span class="source-line-no">054</span><span id="line-54"> * parameter, this method will be called on each newly created instance</span>
<span class="source-line-no">055</span><span id="line-55"> * to identify the associated factory.  This makes factory configuration</span>
<span class="source-line-no">056</span><span id="line-56"> * attributes available to the Log instance, if it so desires.</span>
<span class="source-line-no">057</span><span id="line-57"> * &lt;p&gt;</span>
<span class="source-line-no">058</span><span id="line-58"> * This factory will remember previously created {@code Log} instances</span>
<span class="source-line-no">059</span><span id="line-59"> * for the same name, and will return them on repeated requests to the</span>
<span class="source-line-no">060</span><span id="line-60"> * {@code getInstance()} method.</span>
<span class="source-line-no">061</span><span id="line-61"> */</span>
<span class="source-line-no">062</span><span id="line-62">public class LogFactoryImpl extends LogFactory {</span>
<span class="source-line-no">063</span><span id="line-63"></span>
<span class="source-line-no">064</span><span id="line-64">    /** Log4JLogger class name */</span>
<span class="source-line-no">065</span><span id="line-65">    private static final String LOGGING_IMPL_LOG4J_LOGGER = "org.apache.commons.logging.impl.Log4JLogger";</span>
<span class="source-line-no">066</span><span id="line-66">    /** Jdk14Logger class name */</span>
<span class="source-line-no">067</span><span id="line-67">    private static final String LOGGING_IMPL_JDK14_LOGGER = "org.apache.commons.logging.impl.Jdk14Logger";</span>
<span class="source-line-no">068</span><span id="line-68">    /** Jdk13LumberjackLogger class name */</span>
<span class="source-line-no">069</span><span id="line-69">    private static final String LOGGING_IMPL_LUMBERJACK_LOGGER =</span>
<span class="source-line-no">070</span><span id="line-70">            "org.apache.commons.logging.impl.Jdk13LumberjackLogger";</span>
<span class="source-line-no">071</span><span id="line-71"></span>
<span class="source-line-no">072</span><span id="line-72">    /** SimpleLog class name */</span>
<span class="source-line-no">073</span><span id="line-73">    private static final String LOGGING_IMPL_SIMPLE_LOGGER = "org.apache.commons.logging.impl.SimpleLog";</span>
<span class="source-line-no">074</span><span id="line-74"></span>
<span class="source-line-no">075</span><span id="line-75">    private static final String PKG_IMPL="org.apache.commons.logging.impl.";</span>
<span class="source-line-no">076</span><span id="line-76">    private static final int PKG_LEN = PKG_IMPL.length();</span>
<span class="source-line-no">077</span><span id="line-77"></span>
<span class="source-line-no">078</span><span id="line-78">    /**</span>
<span class="source-line-no">079</span><span id="line-79">     * An empty immutable {@code String} array.</span>
<span class="source-line-no">080</span><span id="line-80">     */</span>
<span class="source-line-no">081</span><span id="line-81">    private static final String[] EMPTY_STRING_ARRAY = {};</span>
<span class="source-line-no">082</span><span id="line-82"></span>
<span class="source-line-no">083</span><span id="line-83">    /**</span>
<span class="source-line-no">084</span><span id="line-84">     * The name ({@code org.apache.commons.logging.Log}) of the system</span>
<span class="source-line-no">085</span><span id="line-85">     * property identifying our {@link Log} implementation class.</span>
<span class="source-line-no">086</span><span id="line-86">     */</span>
<span class="source-line-no">087</span><span id="line-87">    public static final String LOG_PROPERTY = "org.apache.commons.logging.Log";</span>
<span class="source-line-no">088</span><span id="line-88"></span>
<span class="source-line-no">089</span><span id="line-89">    /**</span>
<span class="source-line-no">090</span><span id="line-90">     * The deprecated system property used for backwards compatibility with</span>
<span class="source-line-no">091</span><span id="line-91">     * old versions of JCL.</span>
<span class="source-line-no">092</span><span id="line-92">     */</span>
<span class="source-line-no">093</span><span id="line-93">    protected static final String LOG_PROPERTY_OLD = "org.apache.commons.logging.log";</span>
<span class="source-line-no">094</span><span id="line-94"></span>
<span class="source-line-no">095</span><span id="line-95">    /**</span>
<span class="source-line-no">096</span><span id="line-96">     * The name ({@code org.apache.commons.logging.Log.allowFlawedContext})</span>
<span class="source-line-no">097</span><span id="line-97">     * of the system property which can be set true/false to</span>
<span class="source-line-no">098</span><span id="line-98">     * determine system behavior when a bad context class loader is encountered.</span>
<span class="source-line-no">099</span><span id="line-99">     * When set to false, a LogConfigurationException is thrown if</span>
<span class="source-line-no">100</span><span id="line-100">     * LogFactoryImpl is loaded via a child class loader of the TCCL (this</span>
<span class="source-line-no">101</span><span id="line-101">     * should never happen in sane systems).</span>
<span class="source-line-no">102</span><span id="line-102">     *</span>
<span class="source-line-no">103</span><span id="line-103">     * Default behavior: true (tolerates bad context class loaders)</span>
<span class="source-line-no">104</span><span id="line-104">     *</span>
<span class="source-line-no">105</span><span id="line-105">     * See also method setAttribute.</span>
<span class="source-line-no">106</span><span id="line-106">     */</span>
<span class="source-line-no">107</span><span id="line-107">    public static final String ALLOW_FLAWED_CONTEXT_PROPERTY =</span>
<span class="source-line-no">108</span><span id="line-108">        "org.apache.commons.logging.Log.allowFlawedContext";</span>
<span class="source-line-no">109</span><span id="line-109"></span>
<span class="source-line-no">110</span><span id="line-110">    /**</span>
<span class="source-line-no">111</span><span id="line-111">     * The name ({@code org.apache.commons.logging.Log.allowFlawedDiscovery})</span>
<span class="source-line-no">112</span><span id="line-112">     * of the system property which can be set true/false to</span>
<span class="source-line-no">113</span><span id="line-113">     * determine system behavior when a bad logging adapter class is</span>
<span class="source-line-no">114</span><span id="line-114">     * encountered during logging discovery. When set to false, an</span>
<span class="source-line-no">115</span><span id="line-115">     * exception will be thrown and the app will fail to start. When set</span>
<span class="source-line-no">116</span><span id="line-116">     * to true, discovery will continue (though the user might end up</span>
<span class="source-line-no">117</span><span id="line-117">     * with a different logging implementation than they expected).</span>
<span class="source-line-no">118</span><span id="line-118">     * &lt;p&gt;</span>
<span class="source-line-no">119</span><span id="line-119">     * Default behavior: true (tolerates bad logging adapters)</span>
<span class="source-line-no">120</span><span id="line-120">     *</span>
<span class="source-line-no">121</span><span id="line-121">     * See also method setAttribute.</span>
<span class="source-line-no">122</span><span id="line-122">     */</span>
<span class="source-line-no">123</span><span id="line-123">    public static final String ALLOW_FLAWED_DISCOVERY_PROPERTY =</span>
<span class="source-line-no">124</span><span id="line-124">        "org.apache.commons.logging.Log.allowFlawedDiscovery";</span>
<span class="source-line-no">125</span><span id="line-125"></span>
<span class="source-line-no">126</span><span id="line-126">    /**</span>
<span class="source-line-no">127</span><span id="line-127">     * The name ({@code org.apache.commons.logging.Log.allowFlawedHierarchy})</span>
<span class="source-line-no">128</span><span id="line-128">     * of the system property which can be set true/false to</span>
<span class="source-line-no">129</span><span id="line-129">     * determine system behavior when a logging adapter class is</span>
<span class="source-line-no">130</span><span id="line-130">     * encountered which has bound to the wrong Log class implementation.</span>
<span class="source-line-no">131</span><span id="line-131">     * When set to false, an exception will be thrown and the app will fail</span>
<span class="source-line-no">132</span><span id="line-132">     * to start. When set to true, discovery will continue (though the user</span>
<span class="source-line-no">133</span><span id="line-133">     * might end up with a different logging implementation than they expected).</span>
<span class="source-line-no">134</span><span id="line-134">     * &lt;p&gt;</span>
<span class="source-line-no">135</span><span id="line-135">     * Default behavior: true (tolerates bad Log class hierarchy)</span>
<span class="source-line-no">136</span><span id="line-136">     *</span>
<span class="source-line-no">137</span><span id="line-137">     * See also method setAttribute.</span>
<span class="source-line-no">138</span><span id="line-138">     */</span>
<span class="source-line-no">139</span><span id="line-139">    public static final String ALLOW_FLAWED_HIERARCHY_PROPERTY =</span>
<span class="source-line-no">140</span><span id="line-140">        "org.apache.commons.logging.Log.allowFlawedHierarchy";</span>
<span class="source-line-no">141</span><span id="line-141"></span>
<span class="source-line-no">142</span><span id="line-142">    /**</span>
<span class="source-line-no">143</span><span id="line-143">     * The names of classes that will be tried (in order) as logging</span>
<span class="source-line-no">144</span><span id="line-144">     * adapters. Each class is expected to implement the Log interface,</span>
<span class="source-line-no">145</span><span id="line-145">     * and to throw NoClassDefFound or ExceptionInInitializerError when</span>
<span class="source-line-no">146</span><span id="line-146">     * loaded if the underlying logging library is not available. Any</span>
<span class="source-line-no">147</span><span id="line-147">     * other error indicates that the underlying logging library is available</span>
<span class="source-line-no">148</span><span id="line-148">     * but broken/unusable for some reason.</span>
<span class="source-line-no">149</span><span id="line-149">     */</span>
<span class="source-line-no">150</span><span id="line-150">    private static final String[] classesToDiscover = {</span>
<span class="source-line-no">151</span><span id="line-151">            LOGGING_IMPL_JDK14_LOGGER,</span>
<span class="source-line-no">152</span><span id="line-152">            LOGGING_IMPL_SIMPLE_LOGGER</span>
<span class="source-line-no">153</span><span id="line-153">    };</span>
<span class="source-line-no">154</span><span id="line-154"></span>
<span class="source-line-no">155</span><span id="line-155">    /**</span>
<span class="source-line-no">156</span><span id="line-156">     * Workaround for bug in Java1.2; in theory this method is not needed. {@link LogFactory#getClassLoader(Class)}.</span>
<span class="source-line-no">157</span><span id="line-157">     *</span>
<span class="source-line-no">158</span><span id="line-158">     * @param clazz See {@link LogFactory#getClassLoader(Class)}.</span>
<span class="source-line-no">159</span><span id="line-159">     * @return See {@link LogFactory#getClassLoader(Class)}.</span>
<span class="source-line-no">160</span><span id="line-160">     * @since 1.1</span>
<span class="source-line-no">161</span><span id="line-161">     */</span>
<span class="source-line-no">162</span><span id="line-162">    protected static ClassLoader getClassLoader(final Class&lt;?&gt; clazz) {</span>
<span class="source-line-no">163</span><span id="line-163">        return LogFactory.getClassLoader(clazz);</span>
<span class="source-line-no">164</span><span id="line-164">    }</span>
<span class="source-line-no">165</span><span id="line-165"></span>
<span class="source-line-no">166</span><span id="line-166">    /**</span>
<span class="source-line-no">167</span><span id="line-167">     * Gets the context ClassLoader.</span>
<span class="source-line-no">168</span><span id="line-168">     * This method is a workaround for a Java 1.2 compiler bug.</span>
<span class="source-line-no">169</span><span id="line-169">     *</span>
<span class="source-line-no">170</span><span id="line-170">     * @return the context ClassLoader</span>
<span class="source-line-no">171</span><span id="line-171">     * @since 1.1</span>
<span class="source-line-no">172</span><span id="line-172">     */</span>
<span class="source-line-no">173</span><span id="line-173">    protected static ClassLoader getContextClassLoader() throws LogConfigurationException {</span>
<span class="source-line-no">174</span><span id="line-174">        return LogFactory.getContextClassLoader();</span>
<span class="source-line-no">175</span><span id="line-175">    }</span>
<span class="source-line-no">176</span><span id="line-176"></span>
<span class="source-line-no">177</span><span id="line-177">    /**</span>
<span class="source-line-no">178</span><span id="line-178">     * Calls LogFactory.directGetContextClassLoader under the control of an</span>
<span class="source-line-no">179</span><span id="line-179">     * AccessController class. This means that Java code running under a</span>
<span class="source-line-no">180</span><span id="line-180">     * security manager that forbids access to ClassLoaders will still work</span>
<span class="source-line-no">181</span><span id="line-181">     * if this class is given appropriate privileges, even when the caller</span>
<span class="source-line-no">182</span><span id="line-182">     * doesn't have such privileges. Without using an AccessController, the</span>
<span class="source-line-no">183</span><span id="line-183">     * the entire call stack must have the privilege before the call is</span>
<span class="source-line-no">184</span><span id="line-184">     * allowed.</span>
<span class="source-line-no">185</span><span id="line-185">     *</span>
<span class="source-line-no">186</span><span id="line-186">     * @return the context class loader associated with the current thread,</span>
<span class="source-line-no">187</span><span id="line-187">     * or null if security doesn't allow it.</span>
<span class="source-line-no">188</span><span id="line-188">     *</span>
<span class="source-line-no">189</span><span id="line-189">     * @throws LogConfigurationException if there was some weird error while</span>
<span class="source-line-no">190</span><span id="line-190">     * attempting to get the context class loader.</span>
<span class="source-line-no">191</span><span id="line-191">     *</span>
<span class="source-line-no">192</span><span id="line-192">     * @throws SecurityException if the current Java security policy doesn't</span>
<span class="source-line-no">193</span><span id="line-193">     * allow this class to access the context class loader.</span>
<span class="source-line-no">194</span><span id="line-194">     */</span>
<span class="source-line-no">195</span><span id="line-195">    private static ClassLoader getContextClassLoaderInternal()</span>
<span class="source-line-no">196</span><span id="line-196">            throws LogConfigurationException {</span>
<span class="source-line-no">197</span><span id="line-197">        return AccessController.doPrivileged((PrivilegedAction&lt;ClassLoader&gt;) LogFactory::directGetContextClassLoader);</span>
<span class="source-line-no">198</span><span id="line-198">    }</span>
<span class="source-line-no">199</span><span id="line-199"></span>
<span class="source-line-no">200</span><span id="line-200">    /**</span>
<span class="source-line-no">201</span><span id="line-201">     * Read the specified system property, using an AccessController so that</span>
<span class="source-line-no">202</span><span id="line-202">     * the property can be read if JCL has been granted the appropriate</span>
<span class="source-line-no">203</span><span id="line-203">     * security rights even if the calling code has not.</span>
<span class="source-line-no">204</span><span id="line-204">     * &lt;p&gt;</span>
<span class="source-line-no">205</span><span id="line-205">     * Take care not to expose the value returned by this method to the</span>
<span class="source-line-no">206</span><span id="line-206">     * calling application in any way; otherwise the calling app can use that</span>
<span class="source-line-no">207</span><span id="line-207">     * info to access data that should not be available to it.</span>
<span class="source-line-no">208</span><span id="line-208">     */</span>
<span class="source-line-no">209</span><span id="line-209">    private static String getSystemProperty(final String key, final String def)</span>
<span class="source-line-no">210</span><span id="line-210">            throws SecurityException {</span>
<span class="source-line-no">211</span><span id="line-211">        return AccessController.doPrivileged((PrivilegedAction&lt;String&gt;) () -&gt; System.getProperty(key, def));</span>
<span class="source-line-no">212</span><span id="line-212">    }</span>
<span class="source-line-no">213</span><span id="line-213"></span>
<span class="source-line-no">214</span><span id="line-214">    /**</span>
<span class="source-line-no">215</span><span id="line-215">     * Workaround for bug in Java1.2; in theory this method is not needed.</span>
<span class="source-line-no">216</span><span id="line-216">     *</span>
<span class="source-line-no">217</span><span id="line-217">     * @return Same as {@link LogFactory#isDiagnosticsEnabled()}.</span>
<span class="source-line-no">218</span><span id="line-218">     * @see LogFactory#isDiagnosticsEnabled()</span>
<span class="source-line-no">219</span><span id="line-219">     */</span>
<span class="source-line-no">220</span><span id="line-220">    protected static boolean isDiagnosticsEnabled() {</span>
<span class="source-line-no">221</span><span id="line-221">        return LogFactory.isDiagnosticsEnabled();</span>
<span class="source-line-no">222</span><span id="line-222">    }</span>
<span class="source-line-no">223</span><span id="line-223"></span>
<span class="source-line-no">224</span><span id="line-224">    /** Utility method to safely trim a string. */</span>
<span class="source-line-no">225</span><span id="line-225">    private static String trim(final String src) {</span>
<span class="source-line-no">226</span><span id="line-226">        if (src == null) {</span>
<span class="source-line-no">227</span><span id="line-227">            return null;</span>
<span class="source-line-no">228</span><span id="line-228">        }</span>
<span class="source-line-no">229</span><span id="line-229">        return src.trim();</span>
<span class="source-line-no">230</span><span id="line-230">    }</span>
<span class="source-line-no">231</span><span id="line-231"></span>
<span class="source-line-no">232</span><span id="line-232">    /**</span>
<span class="source-line-no">233</span><span id="line-233">     * Determines whether logging classes should be loaded using the thread-context</span>
<span class="source-line-no">234</span><span id="line-234">     * class loader, or via the class loader that loaded this LogFactoryImpl class.</span>
<span class="source-line-no">235</span><span id="line-235">     */</span>
<span class="source-line-no">236</span><span id="line-236">    private boolean useTCCL = true;</span>
<span class="source-line-no">237</span><span id="line-237"></span>
<span class="source-line-no">238</span><span id="line-238">    /**</span>
<span class="source-line-no">239</span><span id="line-239">     * The string prefixed to every message output by the logDiagnostic method.</span>
<span class="source-line-no">240</span><span id="line-240">     */</span>
<span class="source-line-no">241</span><span id="line-241">    private String diagnosticPrefix;</span>
<span class="source-line-no">242</span><span id="line-242"></span>
<span class="source-line-no">243</span><span id="line-243">    /**</span>
<span class="source-line-no">244</span><span id="line-244">     * Configuration attributes.</span>
<span class="source-line-no">245</span><span id="line-245">     */</span>
<span class="source-line-no">246</span><span id="line-246">    protected Hashtable&lt;String, Object&gt; attributes = new Hashtable&lt;&gt;();</span>
<span class="source-line-no">247</span><span id="line-247"></span>
<span class="source-line-no">248</span><span id="line-248">    /**</span>
<span class="source-line-no">249</span><span id="line-249">     * The {@link org.apache.commons.logging.Log} instances that have</span>
<span class="source-line-no">250</span><span id="line-250">     * already been created, keyed by logger name.</span>
<span class="source-line-no">251</span><span id="line-251">     */</span>
<span class="source-line-no">252</span><span id="line-252">    protected Hashtable&lt;String, Log&gt; instances = new Hashtable&lt;&gt;();</span>
<span class="source-line-no">253</span><span id="line-253"></span>
<span class="source-line-no">254</span><span id="line-254">    /**</span>
<span class="source-line-no">255</span><span id="line-255">     * Name of the class implementing the Log interface.</span>
<span class="source-line-no">256</span><span id="line-256">     */</span>
<span class="source-line-no">257</span><span id="line-257">    private String logClassName;</span>
<span class="source-line-no">258</span><span id="line-258"></span>
<span class="source-line-no">259</span><span id="line-259">    /**</span>
<span class="source-line-no">260</span><span id="line-260">     * The one-argument constructor of the</span>
<span class="source-line-no">261</span><span id="line-261">     * {@link org.apache.commons.logging.Log}</span>
<span class="source-line-no">262</span><span id="line-262">     * implementation class that will be used to create new instances.</span>
<span class="source-line-no">263</span><span id="line-263">     * This value is initialized by {@code getLogConstructor()},</span>
<span class="source-line-no">264</span><span id="line-264">     * and then returned repeatedly.</span>
<span class="source-line-no">265</span><span id="line-265">     */</span>
<span class="source-line-no">266</span><span id="line-266">    protected Constructor&lt;?&gt; logConstructor;</span>
<span class="source-line-no">267</span><span id="line-267"></span>
<span class="source-line-no">268</span><span id="line-268">    /**</span>
<span class="source-line-no">269</span><span id="line-269">     * The signature of the Constructor to be used.</span>
<span class="source-line-no">270</span><span id="line-270">     */</span>
<span class="source-line-no">271</span><span id="line-271">    protected Class&lt;?&gt;[] logConstructorSignature = { String.class };</span>
<span class="source-line-no">272</span><span id="line-272"></span>
<span class="source-line-no">273</span><span id="line-273">    /**</span>
<span class="source-line-no">274</span><span id="line-274">     * The one-argument {@code setLogFactory} method of the selected</span>
<span class="source-line-no">275</span><span id="line-275">     * {@link org.apache.commons.logging.Log} method, if it exists.</span>
<span class="source-line-no">276</span><span id="line-276">     */</span>
<span class="source-line-no">277</span><span id="line-277">    protected Method logMethod;</span>
<span class="source-line-no">278</span><span id="line-278"></span>
<span class="source-line-no">279</span><span id="line-279">    /**</span>
<span class="source-line-no">280</span><span id="line-280">     * The signature of the {@code setLogFactory} method to be used.</span>
<span class="source-line-no">281</span><span id="line-281">     */</span>
<span class="source-line-no">282</span><span id="line-282">    protected Class&lt;?&gt;[] logMethodSignature = { LogFactory.class };</span>
<span class="source-line-no">283</span><span id="line-283"></span>
<span class="source-line-no">284</span><span id="line-284">    /**</span>
<span class="source-line-no">285</span><span id="line-285">     * See getBaseClassLoader and initConfiguration.</span>
<span class="source-line-no">286</span><span id="line-286">     */</span>
<span class="source-line-no">287</span><span id="line-287">    private boolean allowFlawedContext;</span>
<span class="source-line-no">288</span><span id="line-288"></span>
<span class="source-line-no">289</span><span id="line-289">    /**</span>
<span class="source-line-no">290</span><span id="line-290">     * See handleFlawedDiscovery and initConfiguration.</span>
<span class="source-line-no">291</span><span id="line-291">     */</span>
<span class="source-line-no">292</span><span id="line-292">    private boolean allowFlawedDiscovery;</span>
<span class="source-line-no">293</span><span id="line-293"></span>
<span class="source-line-no">294</span><span id="line-294">    /**</span>
<span class="source-line-no">295</span><span id="line-295">     * See handleFlawedHierarchy and initConfiguration.</span>
<span class="source-line-no">296</span><span id="line-296">     */</span>
<span class="source-line-no">297</span><span id="line-297">    private boolean allowFlawedHierarchy;</span>
<span class="source-line-no">298</span><span id="line-298"></span>
<span class="source-line-no">299</span><span id="line-299">    /**</span>
<span class="source-line-no">300</span><span id="line-300">     * Public no-arguments constructor required by the lookup mechanism.</span>
<span class="source-line-no">301</span><span id="line-301">     */</span>
<span class="source-line-no">302</span><span id="line-302">    public LogFactoryImpl() {</span>
<span class="source-line-no">303</span><span id="line-303">        initDiagnostics();  // method on this object</span>
<span class="source-line-no">304</span><span id="line-304">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">305</span><span id="line-305">            logDiagnostic("Instance created.");</span>
<span class="source-line-no">306</span><span id="line-306">        }</span>
<span class="source-line-no">307</span><span id="line-307">    }</span>
<span class="source-line-no">308</span><span id="line-308"></span>
<span class="source-line-no">309</span><span id="line-309">    /**</span>
<span class="source-line-no">310</span><span id="line-310">     * Attempts to load the given class, find a suitable constructor,</span>
<span class="source-line-no">311</span><span id="line-311">     * and instantiate an instance of Log.</span>
<span class="source-line-no">312</span><span id="line-312">     *</span>
<span class="source-line-no">313</span><span id="line-313">     * @param logAdapterClassName class name of the Log implementation</span>
<span class="source-line-no">314</span><span id="line-314">     * @param logCategory  argument to pass to the Log implementation's constructor</span>
<span class="source-line-no">315</span><span id="line-315">     * @param affectState  {@code true} if this object's state should</span>
<span class="source-line-no">316</span><span id="line-316">     *  be affected by this method call, {@code false} otherwise.</span>
<span class="source-line-no">317</span><span id="line-317">     * @return  an instance of the given class, or null if the logging</span>
<span class="source-line-no">318</span><span id="line-318">     *  library associated with the specified adapter is not available.</span>
<span class="source-line-no">319</span><span id="line-319">     * @throws LogConfigurationException if there was a serious error with</span>
<span class="source-line-no">320</span><span id="line-320">     *  configuration and the handleFlawedDiscovery method decided this</span>
<span class="source-line-no">321</span><span id="line-321">     *  problem was fatal.</span>
<span class="source-line-no">322</span><span id="line-322">     */</span>
<span class="source-line-no">323</span><span id="line-323">    private Log createLogFromClass(final String logAdapterClassName,</span>
<span class="source-line-no">324</span><span id="line-324">                                   final String logCategory,</span>
<span class="source-line-no">325</span><span id="line-325">                                   final boolean affectState)</span>
<span class="source-line-no">326</span><span id="line-326">        throws LogConfigurationException {</span>
<span class="source-line-no">327</span><span id="line-327"></span>
<span class="source-line-no">328</span><span id="line-328">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">329</span><span id="line-329">            logDiagnostic("Attempting to instantiate '" + logAdapterClassName + "'");</span>
<span class="source-line-no">330</span><span id="line-330">        }</span>
<span class="source-line-no">331</span><span id="line-331"></span>
<span class="source-line-no">332</span><span id="line-332">        final Object[] params = { logCategory };</span>
<span class="source-line-no">333</span><span id="line-333">        Log logAdapter = null;</span>
<span class="source-line-no">334</span><span id="line-334">        Constructor&lt;?&gt; constructor = null;</span>
<span class="source-line-no">335</span><span id="line-335"></span>
<span class="source-line-no">336</span><span id="line-336">        Class&lt;?&gt; logAdapterClass = null;</span>
<span class="source-line-no">337</span><span id="line-337">        ClassLoader currentCL = getBaseClassLoader();</span>
<span class="source-line-no">338</span><span id="line-338"></span>
<span class="source-line-no">339</span><span id="line-339">        for(;;) {</span>
<span class="source-line-no">340</span><span id="line-340">            // Loop through the class loader hierarchy trying to find</span>
<span class="source-line-no">341</span><span id="line-341">            // a viable class loader.</span>
<span class="source-line-no">342</span><span id="line-342">            logDiagnostic("Trying to load '" + logAdapterClassName + "' from class loader " + objectId(currentCL));</span>
<span class="source-line-no">343</span><span id="line-343">            try {</span>
<span class="source-line-no">344</span><span id="line-344">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">345</span><span id="line-345">                    // Show the location of the first occurrence of the .class file</span>
<span class="source-line-no">346</span><span id="line-346">                    // in the classpath. This is the location that ClassLoader.loadClass</span>
<span class="source-line-no">347</span><span id="line-347">                    // will load the class from -- unless the class loader is doing</span>
<span class="source-line-no">348</span><span id="line-348">                    // something weird.</span>
<span class="source-line-no">349</span><span id="line-349">                    URL url;</span>
<span class="source-line-no">350</span><span id="line-350">                    final String resourceName = logAdapterClassName.replace('.', '/') + ".class";</span>
<span class="source-line-no">351</span><span id="line-351">                    if (currentCL != null) {</span>
<span class="source-line-no">352</span><span id="line-352">                        url = currentCL.getResource(resourceName );</span>
<span class="source-line-no">353</span><span id="line-353">                    } else {</span>
<span class="source-line-no">354</span><span id="line-354">                        url = ClassLoader.getSystemResource(resourceName + ".class");</span>
<span class="source-line-no">355</span><span id="line-355">                    }</span>
<span class="source-line-no">356</span><span id="line-356"></span>
<span class="source-line-no">357</span><span id="line-357">                    if (url == null) {</span>
<span class="source-line-no">358</span><span id="line-358">                        logDiagnostic("Class '" + logAdapterClassName + "' [" + resourceName + "] cannot be found.");</span>
<span class="source-line-no">359</span><span id="line-359">                    } else {</span>
<span class="source-line-no">360</span><span id="line-360">                        logDiagnostic("Class '" + logAdapterClassName + "' was found at '" + url + "'");</span>
<span class="source-line-no">361</span><span id="line-361">                    }</span>
<span class="source-line-no">362</span><span id="line-362">                }</span>
<span class="source-line-no">363</span><span id="line-363"></span>
<span class="source-line-no">364</span><span id="line-364">                Class&lt;?&gt; clazz;</span>
<span class="source-line-no">365</span><span id="line-365">                try {</span>
<span class="source-line-no">366</span><span id="line-366">                    clazz = Class.forName(logAdapterClassName, true, currentCL);</span>
<span class="source-line-no">367</span><span id="line-367">                } catch (final ClassNotFoundException originalClassNotFoundException) {</span>
<span class="source-line-no">368</span><span id="line-368">                    // The current class loader was unable to find the log adapter</span>
<span class="source-line-no">369</span><span id="line-369">                    // in this or any ancestor class loader. There's no point in</span>
<span class="source-line-no">370</span><span id="line-370">                    // trying higher up in the hierarchy in this case..</span>
<span class="source-line-no">371</span><span id="line-371">                    String msg = originalClassNotFoundException.getMessage();</span>
<span class="source-line-no">372</span><span id="line-372">                    logDiagnostic("The log adapter '" + logAdapterClassName + "' is not available via class loader " +</span>
<span class="source-line-no">373</span><span id="line-373">                                  objectId(currentCL) + ": " + trim(msg));</span>
<span class="source-line-no">374</span><span id="line-374">                    try {</span>
<span class="source-line-no">375</span><span id="line-375">                        // Try the class class loader.</span>
<span class="source-line-no">376</span><span id="line-376">                        // This may work in cases where the TCCL</span>
<span class="source-line-no">377</span><span id="line-377">                        // does not contain the code executed or JCL.</span>
<span class="source-line-no">378</span><span id="line-378">                        // This behavior indicates that the application</span>
<span class="source-line-no">379</span><span id="line-379">                        // classloading strategy is not consistent with the</span>
<span class="source-line-no">380</span><span id="line-380">                        // Java 1.2 classloading guidelines but JCL can</span>
<span class="source-line-no">381</span><span id="line-381">                        // and so should handle this case.</span>
<span class="source-line-no">382</span><span id="line-382">                        clazz = Class.forName(logAdapterClassName);</span>
<span class="source-line-no">383</span><span id="line-383">                    } catch (final ClassNotFoundException secondaryClassNotFoundException) {</span>
<span class="source-line-no">384</span><span id="line-384">                        // no point continuing: this adapter isn't available</span>
<span class="source-line-no">385</span><span id="line-385">                        msg = secondaryClassNotFoundException.getMessage();</span>
<span class="source-line-no">386</span><span id="line-386">                        logDiagnostic("The log adapter '" + logAdapterClassName +</span>
<span class="source-line-no">387</span><span id="line-387">                                      "' is not available via the LogFactoryImpl class class loader: " + trim(msg));</span>
<span class="source-line-no">388</span><span id="line-388">                        break;</span>
<span class="source-line-no">389</span><span id="line-389">                    }</span>
<span class="source-line-no">390</span><span id="line-390">                }</span>
<span class="source-line-no">391</span><span id="line-391"></span>
<span class="source-line-no">392</span><span id="line-392">                constructor = clazz.getConstructor(logConstructorSignature);</span>
<span class="source-line-no">393</span><span id="line-393">                final Object o = constructor.newInstance(params);</span>
<span class="source-line-no">394</span><span id="line-394"></span>
<span class="source-line-no">395</span><span id="line-395">                // Note that we do this test after trying to create an instance</span>
<span class="source-line-no">396</span><span id="line-396">                // [rather than testing Log.class.isAssignableFrom(c)] so that</span>
<span class="source-line-no">397</span><span id="line-397">                // we don't complain about Log hierarchy problems when the</span>
<span class="source-line-no">398</span><span id="line-398">                // adapter couldn't be instantiated anyway.</span>
<span class="source-line-no">399</span><span id="line-399">                if (o instanceof Log) {</span>
<span class="source-line-no">400</span><span id="line-400">                    logAdapterClass = clazz;</span>
<span class="source-line-no">401</span><span id="line-401">                    logAdapter = (Log) o;</span>
<span class="source-line-no">402</span><span id="line-402">                    break;</span>
<span class="source-line-no">403</span><span id="line-403">                }</span>
<span class="source-line-no">404</span><span id="line-404"></span>
<span class="source-line-no">405</span><span id="line-405">                // Oops, we have a potential problem here. An adapter class</span>
<span class="source-line-no">406</span><span id="line-406">                // has been found and its underlying lib is present too, but</span>
<span class="source-line-no">407</span><span id="line-407">                // there are multiple Log interface classes available making it</span>
<span class="source-line-no">408</span><span id="line-408">                // impossible to cast to the type the caller wanted. We</span>
<span class="source-line-no">409</span><span id="line-409">                // certainly can't use this logger, but we need to know whether</span>
<span class="source-line-no">410</span><span id="line-410">                // to keep on discovering or terminate now.</span>
<span class="source-line-no">411</span><span id="line-411">                //</span>
<span class="source-line-no">412</span><span id="line-412">                // The handleFlawedHierarchy method will throw</span>
<span class="source-line-no">413</span><span id="line-413">                // LogConfigurationException if it regards this problem as</span>
<span class="source-line-no">414</span><span id="line-414">                // fatal, and just return if not.</span>
<span class="source-line-no">415</span><span id="line-415">                handleFlawedHierarchy(currentCL, clazz);</span>
<span class="source-line-no">416</span><span id="line-416">            } catch (final NoClassDefFoundError e) {</span>
<span class="source-line-no">417</span><span id="line-417">                // We were able to load the adapter but it had references to</span>
<span class="source-line-no">418</span><span id="line-418">                // other classes that could not be found. This simply means that</span>
<span class="source-line-no">419</span><span id="line-419">                // the underlying logger library is not present in this or any</span>
<span class="source-line-no">420</span><span id="line-420">                // ancestor class loader. There's no point in trying higher up</span>
<span class="source-line-no">421</span><span id="line-421">                // in the hierarchy in this case..</span>
<span class="source-line-no">422</span><span id="line-422">                final String msg = e.getMessage();</span>
<span class="source-line-no">423</span><span id="line-423">                logDiagnostic("The log adapter '" + logAdapterClassName +</span>
<span class="source-line-no">424</span><span id="line-424">                              "' is missing dependencies when loaded via class loader " + objectId(currentCL) +</span>
<span class="source-line-no">425</span><span id="line-425">                              ": " + trim(msg));</span>
<span class="source-line-no">426</span><span id="line-426">                break;</span>
<span class="source-line-no">427</span><span id="line-427">            } catch (final ExceptionInInitializerError e) {</span>
<span class="source-line-no">428</span><span id="line-428">                // A static initializer block or the initializer code associated</span>
<span class="source-line-no">429</span><span id="line-429">                // with a static variable on the log adapter class has thrown</span>
<span class="source-line-no">430</span><span id="line-430">                // an exception.</span>
<span class="source-line-no">431</span><span id="line-431">                //</span>
<span class="source-line-no">432</span><span id="line-432">                // We treat this as meaning the adapter's underlying logging</span>
<span class="source-line-no">433</span><span id="line-433">                // library could not be found.</span>
<span class="source-line-no">434</span><span id="line-434">                final String msg = e.getMessage();</span>
<span class="source-line-no">435</span><span id="line-435">                logDiagnostic("The log adapter '" + logAdapterClassName +</span>
<span class="source-line-no">436</span><span id="line-436">                              "' is unable to initialize itself when loaded via class loader " + objectId(currentCL) +</span>
<span class="source-line-no">437</span><span id="line-437">                              ": " + trim(msg));</span>
<span class="source-line-no">438</span><span id="line-438">                break;</span>
<span class="source-line-no">439</span><span id="line-439">            } catch (final LogConfigurationException e) {</span>
<span class="source-line-no">440</span><span id="line-440">                // call to handleFlawedHierarchy above must have thrown</span>
<span class="source-line-no">441</span><span id="line-441">                // a LogConfigurationException, so just throw it on</span>
<span class="source-line-no">442</span><span id="line-442">                throw e;</span>
<span class="source-line-no">443</span><span id="line-443">            } catch (final Throwable t) {</span>
<span class="source-line-no">444</span><span id="line-444">                handleThrowable(t); // may re-throw t</span>
<span class="source-line-no">445</span><span id="line-445">                // handleFlawedDiscovery will determine whether this is a fatal</span>
<span class="source-line-no">446</span><span id="line-446">                // problem or not. If it is fatal, then a LogConfigurationException</span>
<span class="source-line-no">447</span><span id="line-447">                // will be thrown.</span>
<span class="source-line-no">448</span><span id="line-448">                handleFlawedDiscovery(logAdapterClassName, t);</span>
<span class="source-line-no">449</span><span id="line-449">            }</span>
<span class="source-line-no">450</span><span id="line-450"></span>
<span class="source-line-no">451</span><span id="line-451">            if (currentCL == null) {</span>
<span class="source-line-no">452</span><span id="line-452">                break;</span>
<span class="source-line-no">453</span><span id="line-453">            }</span>
<span class="source-line-no">454</span><span id="line-454"></span>
<span class="source-line-no">455</span><span id="line-455">            // try the parent class loader</span>
<span class="source-line-no">456</span><span id="line-456">            // currentCL = currentCL.getParent();</span>
<span class="source-line-no">457</span><span id="line-457">            currentCL = getParentClassLoader(currentCL);</span>
<span class="source-line-no">458</span><span id="line-458">        }</span>
<span class="source-line-no">459</span><span id="line-459"></span>
<span class="source-line-no">460</span><span id="line-460">        if (logAdapterClass != null &amp;&amp; affectState) {</span>
<span class="source-line-no">461</span><span id="line-461">            // We've succeeded, so set instance fields</span>
<span class="source-line-no">462</span><span id="line-462">            this.logClassName   = logAdapterClassName;</span>
<span class="source-line-no">463</span><span id="line-463">            this.logConstructor = constructor;</span>
<span class="source-line-no">464</span><span id="line-464"></span>
<span class="source-line-no">465</span><span id="line-465">            // Identify the {@code setLogFactory} method (if there is one)</span>
<span class="source-line-no">466</span><span id="line-466">            try {</span>
<span class="source-line-no">467</span><span id="line-467">                this.logMethod = logAdapterClass.getMethod("setLogFactory", logMethodSignature);</span>
<span class="source-line-no">468</span><span id="line-468">                logDiagnostic("Found method setLogFactory(LogFactory) in '" + logAdapterClassName + "'");</span>
<span class="source-line-no">469</span><span id="line-469">            } catch (final Throwable t) {</span>
<span class="source-line-no">470</span><span id="line-470">                handleThrowable(t); // may re-throw t</span>
<span class="source-line-no">471</span><span id="line-471">                this.logMethod = null;</span>
<span class="source-line-no">472</span><span id="line-472">                logDiagnostic("[INFO] '" + logAdapterClassName + "' from class loader " + objectId(currentCL) +</span>
<span class="source-line-no">473</span><span id="line-473">                              " does not declare optional method " + "setLogFactory(LogFactory)");</span>
<span class="source-line-no">474</span><span id="line-474">            }</span>
<span class="source-line-no">475</span><span id="line-475"></span>
<span class="source-line-no">476</span><span id="line-476">            logDiagnostic("Log adapter '" + logAdapterClassName + "' from class loader " +</span>
<span class="source-line-no">477</span><span id="line-477">                          objectId(logAdapterClass.getClassLoader()) + " has been selected for use.");</span>
<span class="source-line-no">478</span><span id="line-478">        }</span>
<span class="source-line-no">479</span><span id="line-479"></span>
<span class="source-line-no">480</span><span id="line-480">        return logAdapter;</span>
<span class="source-line-no">481</span><span id="line-481">    }</span>
<span class="source-line-no">482</span><span id="line-482"></span>
<span class="source-line-no">483</span><span id="line-483">        // Static Methods</span>
<span class="source-line-no">484</span><span id="line-484">    //</span>
<span class="source-line-no">485</span><span id="line-485">    // These methods only defined as workarounds for a java 1.2 bug;</span>
<span class="source-line-no">486</span><span id="line-486">    // theoretically none of these are needed.</span>
<span class="source-line-no">487</span><span id="line-487"></span>
<span class="source-line-no">488</span><span id="line-488">    /**</span>
<span class="source-line-no">489</span><span id="line-489">     * Attempts to create a Log instance for the given category name.</span>
<span class="source-line-no">490</span><span id="line-490">     * Follows the discovery process described in the class Javadoc.</span>
<span class="source-line-no">491</span><span id="line-491">     *</span>
<span class="source-line-no">492</span><span id="line-492">     * @param logCategory the name of the log category</span>
<span class="source-line-no">493</span><span id="line-493">     *</span>
<span class="source-line-no">494</span><span id="line-494">     * @throws LogConfigurationException if an error in discovery occurs,</span>
<span class="source-line-no">495</span><span id="line-495">     * or if no adapter at all can be instantiated</span>
<span class="source-line-no">496</span><span id="line-496">     */</span>
<span class="source-line-no">497</span><span id="line-497">    private Log discoverLogImplementation(final String logCategory)</span>
<span class="source-line-no">498</span><span id="line-498">        throws LogConfigurationException {</span>
<span class="source-line-no">499</span><span id="line-499">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">500</span><span id="line-500">            logDiagnostic("Discovering a Log implementation...");</span>
<span class="source-line-no">501</span><span id="line-501">        }</span>
<span class="source-line-no">502</span><span id="line-502"></span>
<span class="source-line-no">503</span><span id="line-503">        initConfiguration();</span>
<span class="source-line-no">504</span><span id="line-504"></span>
<span class="source-line-no">505</span><span id="line-505">        Log result = null;</span>
<span class="source-line-no">506</span><span id="line-506"></span>
<span class="source-line-no">507</span><span id="line-507">        // See if the user specified the Log implementation to use</span>
<span class="source-line-no">508</span><span id="line-508">        final String specifiedLogClassName = findUserSpecifiedLogClassName();</span>
<span class="source-line-no">509</span><span id="line-509"></span>
<span class="source-line-no">510</span><span id="line-510">        if (specifiedLogClassName != null) {</span>
<span class="source-line-no">511</span><span id="line-511">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">512</span><span id="line-512">                logDiagnostic("Attempting to load user-specified log class '" +</span>
<span class="source-line-no">513</span><span id="line-513">                    specifiedLogClassName + "'...");</span>
<span class="source-line-no">514</span><span id="line-514">            }</span>
<span class="source-line-no">515</span><span id="line-515"></span>
<span class="source-line-no">516</span><span id="line-516">            result = createLogFromClass(specifiedLogClassName,</span>
<span class="source-line-no">517</span><span id="line-517">                                        logCategory,</span>
<span class="source-line-no">518</span><span id="line-518">                                        true);</span>
<span class="source-line-no">519</span><span id="line-519">            if (result == null) {</span>
<span class="source-line-no">520</span><span id="line-520">                final StringBuilder messageBuffer =  new StringBuilder("User-specified log class '");</span>
<span class="source-line-no">521</span><span id="line-521">                messageBuffer.append(specifiedLogClassName);</span>
<span class="source-line-no">522</span><span id="line-522">                messageBuffer.append("' cannot be found or is not useable.");</span>
<span class="source-line-no">523</span><span id="line-523"></span>
<span class="source-line-no">524</span><span id="line-524">                // Mistyping or misspelling names is a common fault.</span>
<span class="source-line-no">525</span><span id="line-525">                // Construct a good error message, if we can</span>
<span class="source-line-no">526</span><span id="line-526">                informUponSimilarName(messageBuffer, specifiedLogClassName, LOGGING_IMPL_LOG4J_LOGGER);</span>
<span class="source-line-no">527</span><span id="line-527">                informUponSimilarName(messageBuffer, specifiedLogClassName, LOGGING_IMPL_JDK14_LOGGER);</span>
<span class="source-line-no">528</span><span id="line-528">                informUponSimilarName(messageBuffer, specifiedLogClassName, LOGGING_IMPL_LUMBERJACK_LOGGER);</span>
<span class="source-line-no">529</span><span id="line-529">                informUponSimilarName(messageBuffer, specifiedLogClassName, LOGGING_IMPL_SIMPLE_LOGGER);</span>
<span class="source-line-no">530</span><span id="line-530">                throw new LogConfigurationException(messageBuffer.toString());</span>
<span class="source-line-no">531</span><span id="line-531">            }</span>
<span class="source-line-no">532</span><span id="line-532"></span>
<span class="source-line-no">533</span><span id="line-533">            return result;</span>
<span class="source-line-no">534</span><span id="line-534">        }</span>
<span class="source-line-no">535</span><span id="line-535"></span>
<span class="source-line-no">536</span><span id="line-536">        // No user specified log; try to discover what's on the classpath</span>
<span class="source-line-no">537</span><span id="line-537">        //</span>
<span class="source-line-no">538</span><span id="line-538">        // Note that we deliberately loop here over classesToDiscover and</span>
<span class="source-line-no">539</span><span id="line-539">        // expect method createLogFromClass to loop over the possible source</span>
<span class="source-line-no">540</span><span id="line-540">        // class loaders. The effect is:</span>
<span class="source-line-no">541</span><span id="line-541">        //   for each discoverable log adapter</span>
<span class="source-line-no">542</span><span id="line-542">        //      for each possible class loader</span>
<span class="source-line-no">543</span><span id="line-543">        //          see if it works</span>
<span class="source-line-no">544</span><span id="line-544">        //</span>
<span class="source-line-no">545</span><span id="line-545">        // It appears reasonable at first glance to do the opposite:</span>
<span class="source-line-no">546</span><span id="line-546">        //   for each possible class loader</span>
<span class="source-line-no">547</span><span id="line-547">        //     for each discoverable log adapter</span>
<span class="source-line-no">548</span><span id="line-548">        //        see if it works</span>
<span class="source-line-no">549</span><span id="line-549">        //</span>
<span class="source-line-no">550</span><span id="line-550">        // The latter certainly has advantages for user-installable logging</span>
<span class="source-line-no">551</span><span id="line-551">        // libraries such as Log4j; in a webapp for example this code should</span>
<span class="source-line-no">552</span><span id="line-552">        // first check whether the user has provided any of the possible</span>
<span class="source-line-no">553</span><span id="line-553">        // logging libraries before looking in the parent class loader.</span>
<span class="source-line-no">554</span><span id="line-554">        // Unfortunately, however, Jdk14Logger will always work in jvm&gt;=1.4,</span>
<span class="source-line-no">555</span><span id="line-555">        // and SimpleLog will always work in any JVM. So the loop would never</span>
<span class="source-line-no">556</span><span id="line-556">        // ever look for logging libraries in the parent classpath. Yet many</span>
<span class="source-line-no">557</span><span id="line-557">        // users would expect that putting Log4j there would cause it to be</span>
<span class="source-line-no">558</span><span id="line-558">        // detected (and this is the historical JCL behavior). So we go with</span>
<span class="source-line-no">559</span><span id="line-559">        // the first approach. A user that has bundled a specific logging lib</span>
<span class="source-line-no">560</span><span id="line-560">        // in a webapp should use a commons-logging.properties file or a</span>
<span class="source-line-no">561</span><span id="line-561">        // service file in META-INF to force use of that logging lib anyway,</span>
<span class="source-line-no">562</span><span id="line-562">        // rather than relying on discovery.</span>
<span class="source-line-no">563</span><span id="line-563"></span>
<span class="source-line-no">564</span><span id="line-564">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">565</span><span id="line-565">            logDiagnostic(</span>
<span class="source-line-no">566</span><span id="line-566">                "No user-specified Log implementation; performing discovery" +</span>
<span class="source-line-no">567</span><span id="line-567">                " using the standard supported logging implementations...");</span>
<span class="source-line-no">568</span><span id="line-568">        }</span>
<span class="source-line-no">569</span><span id="line-569">        for(int i=0; i&lt;classesToDiscover.length &amp;&amp; result == null; ++i) {</span>
<span class="source-line-no">570</span><span id="line-570">            result = createLogFromClass(classesToDiscover[i], logCategory, true);</span>
<span class="source-line-no">571</span><span id="line-571">        }</span>
<span class="source-line-no">572</span><span id="line-572"></span>
<span class="source-line-no">573</span><span id="line-573">        if (result == null) {</span>
<span class="source-line-no">574</span><span id="line-574">            throw new LogConfigurationException</span>
<span class="source-line-no">575</span><span id="line-575">                        ("No suitable Log implementation");</span>
<span class="source-line-no">576</span><span id="line-576">        }</span>
<span class="source-line-no">577</span><span id="line-577"></span>
<span class="source-line-no">578</span><span id="line-578">        return result;</span>
<span class="source-line-no">579</span><span id="line-579">    }</span>
<span class="source-line-no">580</span><span id="line-580"></span>
<span class="source-line-no">581</span><span id="line-581">    /**</span>
<span class="source-line-no">582</span><span id="line-582">     * Checks system properties and the attribute map for</span>
<span class="source-line-no">583</span><span id="line-583">     * a Log implementation specified by the user under the</span>
<span class="source-line-no">584</span><span id="line-584">     * property names {@link #LOG_PROPERTY} or {@link #LOG_PROPERTY_OLD}.</span>
<span class="source-line-no">585</span><span id="line-585">     *</span>
<span class="source-line-no">586</span><span id="line-586">     * @return class name specified by the user, or {@code null}</span>
<span class="source-line-no">587</span><span id="line-587">     */</span>
<span class="source-line-no">588</span><span id="line-588">    private String findUserSpecifiedLogClassName() {</span>
<span class="source-line-no">589</span><span id="line-589">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">590</span><span id="line-590">            logDiagnostic("Trying to get log class from attribute '" + LOG_PROPERTY + "'");</span>
<span class="source-line-no">591</span><span id="line-591">        }</span>
<span class="source-line-no">592</span><span id="line-592">        String specifiedClass = (String) getAttribute(LOG_PROPERTY);</span>
<span class="source-line-no">593</span><span id="line-593"></span>
<span class="source-line-no">594</span><span id="line-594">        if (specifiedClass == null) { // @deprecated</span>
<span class="source-line-no">595</span><span id="line-595">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">596</span><span id="line-596">                logDiagnostic("Trying to get log class from attribute '" +</span>
<span class="source-line-no">597</span><span id="line-597">                              LOG_PROPERTY_OLD + "'");</span>
<span class="source-line-no">598</span><span id="line-598">            }</span>
<span class="source-line-no">599</span><span id="line-599">            specifiedClass = (String) getAttribute(LOG_PROPERTY_OLD);</span>
<span class="source-line-no">600</span><span id="line-600">        }</span>
<span class="source-line-no">601</span><span id="line-601"></span>
<span class="source-line-no">602</span><span id="line-602">        if (specifiedClass == null) {</span>
<span class="source-line-no">603</span><span id="line-603">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">604</span><span id="line-604">                logDiagnostic("Trying to get log class from system property '" +</span>
<span class="source-line-no">605</span><span id="line-605">                          LOG_PROPERTY + "'");</span>
<span class="source-line-no">606</span><span id="line-606">            }</span>
<span class="source-line-no">607</span><span id="line-607">            try {</span>
<span class="source-line-no">608</span><span id="line-608">                specifiedClass = getSystemProperty(LOG_PROPERTY, null);</span>
<span class="source-line-no">609</span><span id="line-609">            } catch (final SecurityException e) {</span>
<span class="source-line-no">610</span><span id="line-610">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">611</span><span id="line-611">                    logDiagnostic("No access allowed to system property '" +</span>
<span class="source-line-no">612</span><span id="line-612">                        LOG_PROPERTY + "' - " + e.getMessage());</span>
<span class="source-line-no">613</span><span id="line-613">                }</span>
<span class="source-line-no">614</span><span id="line-614">            }</span>
<span class="source-line-no">615</span><span id="line-615">        }</span>
<span class="source-line-no">616</span><span id="line-616"></span>
<span class="source-line-no">617</span><span id="line-617">        if (specifiedClass == null) { // @deprecated</span>
<span class="source-line-no">618</span><span id="line-618">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">619</span><span id="line-619">                logDiagnostic("Trying to get log class from system property '" +</span>
<span class="source-line-no">620</span><span id="line-620">                          LOG_PROPERTY_OLD + "'");</span>
<span class="source-line-no">621</span><span id="line-621">            }</span>
<span class="source-line-no">622</span><span id="line-622">            try {</span>
<span class="source-line-no">623</span><span id="line-623">                specifiedClass = getSystemProperty(LOG_PROPERTY_OLD, null);</span>
<span class="source-line-no">624</span><span id="line-624">            } catch (final SecurityException e) {</span>
<span class="source-line-no">625</span><span id="line-625">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">626</span><span id="line-626">                    logDiagnostic("No access allowed to system property '" +</span>
<span class="source-line-no">627</span><span id="line-627">                        LOG_PROPERTY_OLD + "' - " + e.getMessage());</span>
<span class="source-line-no">628</span><span id="line-628">                }</span>
<span class="source-line-no">629</span><span id="line-629">            }</span>
<span class="source-line-no">630</span><span id="line-630">        }</span>
<span class="source-line-no">631</span><span id="line-631"></span>
<span class="source-line-no">632</span><span id="line-632">        // Remove any whitespace; it's never valid in a class name so its</span>
<span class="source-line-no">633</span><span id="line-633">        // presence just means a user mistake. As we know what they meant,</span>
<span class="source-line-no">634</span><span id="line-634">        // we may as well strip the spaces.</span>
<span class="source-line-no">635</span><span id="line-635">        if (specifiedClass != null) {</span>
<span class="source-line-no">636</span><span id="line-636">            specifiedClass = specifiedClass.trim();</span>
<span class="source-line-no">637</span><span id="line-637">        }</span>
<span class="source-line-no">638</span><span id="line-638"></span>
<span class="source-line-no">639</span><span id="line-639">        return specifiedClass;</span>
<span class="source-line-no">640</span><span id="line-640">    }</span>
<span class="source-line-no">641</span><span id="line-641"></span>
<span class="source-line-no">642</span><span id="line-642">    /**</span>
<span class="source-line-no">643</span><span id="line-643">     * Gets the configuration attribute with the specified name (if any),</span>
<span class="source-line-no">644</span><span id="line-644">     * or {@code null} if there is no such attribute.</span>
<span class="source-line-no">645</span><span id="line-645">     *</span>
<span class="source-line-no">646</span><span id="line-646">     * @param name Name of the attribute to return</span>
<span class="source-line-no">647</span><span id="line-647">     */</span>
<span class="source-line-no">648</span><span id="line-648">    @Override</span>
<span class="source-line-no">649</span><span id="line-649">    public Object getAttribute(final String name) {</span>
<span class="source-line-no">650</span><span id="line-650">        return attributes.get(name);</span>
<span class="source-line-no">651</span><span id="line-651">    }</span>
<span class="source-line-no">652</span><span id="line-652"></span>
<span class="source-line-no">653</span><span id="line-653">    /**</span>
<span class="source-line-no">654</span><span id="line-654">     * Gets an array containing the names of all currently defined</span>
<span class="source-line-no">655</span><span id="line-655">     * configuration attributes.  If there are no such attributes, a zero</span>
<span class="source-line-no">656</span><span id="line-656">     * length array is returned.</span>
<span class="source-line-no">657</span><span id="line-657">     */</span>
<span class="source-line-no">658</span><span id="line-658">    @Override</span>
<span class="source-line-no">659</span><span id="line-659">    public String[] getAttributeNames() {</span>
<span class="source-line-no">660</span><span id="line-660">        return attributes.keySet().toArray(EMPTY_STRING_ARRAY);</span>
<span class="source-line-no">661</span><span id="line-661">    }</span>
<span class="source-line-no">662</span><span id="line-662"></span>
<span class="source-line-no">663</span><span id="line-663">    /**</span>
<span class="source-line-no">664</span><span id="line-664">     * Gets the class loader from which we should try to load the logging</span>
<span class="source-line-no">665</span><span id="line-665">     * adapter classes.</span>
<span class="source-line-no">666</span><span id="line-666">     * &lt;p&gt;</span>
<span class="source-line-no">667</span><span id="line-667">     * This method usually returns the context class loader. However if it</span>
<span class="source-line-no">668</span><span id="line-668">     * is discovered that the class loader which loaded this class is a child</span>
<span class="source-line-no">669</span><span id="line-669">     * of the context class loader &lt;i&gt;and&lt;/i&gt; the allowFlawedContext option</span>
<span class="source-line-no">670</span><span id="line-670">     * has been set then the class loader which loaded this class is returned</span>
<span class="source-line-no">671</span><span id="line-671">     * instead.</span>
<span class="source-line-no">672</span><span id="line-672">     * &lt;p&gt;</span>
<span class="source-line-no">673</span><span id="line-673">     * The only time when the class loader which loaded this class is a</span>
<span class="source-line-no">674</span><span id="line-674">     * descendant (rather than the same as or an ancestor of the context</span>
<span class="source-line-no">675</span><span id="line-675">     * class loader) is when an app has created custom class loaders but</span>
<span class="source-line-no">676</span><span id="line-676">     * failed to correctly set the context class loader. This is a bug in</span>
<span class="source-line-no">677</span><span id="line-677">     * the calling application; however we provide the option for JCL to</span>
<span class="source-line-no">678</span><span id="line-678">     * simply generate a warning rather than fail outright.</span>
<span class="source-line-no">679</span><span id="line-679">     */</span>
<span class="source-line-no">680</span><span id="line-680">    private ClassLoader getBaseClassLoader() throws LogConfigurationException {</span>
<span class="source-line-no">681</span><span id="line-681">        final ClassLoader thisClassLoader = getClassLoader(LogFactoryImpl.class);</span>
<span class="source-line-no">682</span><span id="line-682"></span>
<span class="source-line-no">683</span><span id="line-683">        if (!useTCCL) {</span>
<span class="source-line-no">684</span><span id="line-684">            return thisClassLoader;</span>
<span class="source-line-no">685</span><span id="line-685">        }</span>
<span class="source-line-no">686</span><span id="line-686"></span>
<span class="source-line-no">687</span><span id="line-687">        final ClassLoader contextClassLoader = getContextClassLoaderInternal();</span>
<span class="source-line-no">688</span><span id="line-688"></span>
<span class="source-line-no">689</span><span id="line-689">        final ClassLoader baseClassLoader = getLowestClassLoader(</span>
<span class="source-line-no">690</span><span id="line-690">                contextClassLoader, thisClassLoader);</span>
<span class="source-line-no">691</span><span id="line-691"></span>
<span class="source-line-no">692</span><span id="line-692">        if (baseClassLoader == null) {</span>
<span class="source-line-no">693</span><span id="line-693">           // The two class loaders are not part of a parent child relationship.</span>
<span class="source-line-no">694</span><span id="line-694">           // In some classloading setups (e.g. JBoss with its</span>
<span class="source-line-no">695</span><span id="line-695">           // UnifiedLoaderRepository) this can still work, so if user hasn't</span>
<span class="source-line-no">696</span><span id="line-696">           // forbidden it, just return the contextClassLoader.</span>
<span class="source-line-no">697</span><span id="line-697">           if (!allowFlawedContext) {</span>
<span class="source-line-no">698</span><span id="line-698">            throw new LogConfigurationException("Bad class loader hierarchy; LogFactoryImpl was loaded via" +</span>
<span class="source-line-no">699</span><span id="line-699">                                                " a class loader that is not related to the current context" +</span>
<span class="source-line-no">700</span><span id="line-700">                                                " class loader.");</span>
<span class="source-line-no">701</span><span id="line-701">           }</span>
<span class="source-line-no">702</span><span id="line-702">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">703</span><span id="line-703">               logDiagnostic("[WARNING] the context class loader is not part of a" +</span>
<span class="source-line-no">704</span><span id="line-704">                             " parent-child relationship with the class loader that" +</span>
<span class="source-line-no">705</span><span id="line-705">                             " loaded LogFactoryImpl.");</span>
<span class="source-line-no">706</span><span id="line-706">          }</span>
<span class="source-line-no">707</span><span id="line-707">          // If contextClassLoader were null, getLowestClassLoader() would</span>
<span class="source-line-no">708</span><span id="line-708">          // have returned thisClassLoader.  The fact we are here means</span>
<span class="source-line-no">709</span><span id="line-709">          // contextClassLoader is not null, so we can just return it.</span>
<span class="source-line-no">710</span><span id="line-710">          return contextClassLoader;</span>
<span class="source-line-no">711</span><span id="line-711">        }</span>
<span class="source-line-no">712</span><span id="line-712"></span>
<span class="source-line-no">713</span><span id="line-713">        if (baseClassLoader != contextClassLoader) {</span>
<span class="source-line-no">714</span><span id="line-714">            // We really should just use the contextClassLoader as the starting</span>
<span class="source-line-no">715</span><span id="line-715">            // point for scanning for log adapter classes. However it is expected</span>
<span class="source-line-no">716</span><span id="line-716">            // that there are a number of broken systems out there which create</span>
<span class="source-line-no">717</span><span id="line-717">            // custom class loaders but fail to set the context class loader so</span>
<span class="source-line-no">718</span><span id="line-718">            // we handle those flawed systems anyway.</span>
<span class="source-line-no">719</span><span id="line-719">            if (!allowFlawedContext) {</span>
<span class="source-line-no">720</span><span id="line-720">                throw new LogConfigurationException(</span>
<span class="source-line-no">721</span><span id="line-721">                        "Bad class loader hierarchy; LogFactoryImpl was loaded via" +</span>
<span class="source-line-no">722</span><span id="line-722">                        " a class loader that is not related to the current context" +</span>
<span class="source-line-no">723</span><span id="line-723">                        " class loader.");</span>
<span class="source-line-no">724</span><span id="line-724">            }</span>
<span class="source-line-no">725</span><span id="line-725">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">726</span><span id="line-726">                logDiagnostic(</span>
<span class="source-line-no">727</span><span id="line-727">                        "Warning: the context class loader is an ancestor of the" +</span>
<span class="source-line-no">728</span><span id="line-728">                        " class loader that loaded LogFactoryImpl; it should be" +</span>
<span class="source-line-no">729</span><span id="line-729">                        " the same or a descendant. The application using" +</span>
<span class="source-line-no">730</span><span id="line-730">                        " commons-logging should ensure the context class loader" +</span>
<span class="source-line-no">731</span><span id="line-731">                        " is used correctly.");</span>
<span class="source-line-no">732</span><span id="line-732">            }</span>
<span class="source-line-no">733</span><span id="line-733">        }</span>
<span class="source-line-no">734</span><span id="line-734"></span>
<span class="source-line-no">735</span><span id="line-735">        return baseClassLoader;</span>
<span class="source-line-no">736</span><span id="line-736">    }</span>
<span class="source-line-no">737</span><span id="line-737"></span>
<span class="source-line-no">738</span><span id="line-738">    /**</span>
<span class="source-line-no">739</span><span id="line-739">     * Gets the setting for the user-configurable behavior specified by key.</span>
<span class="source-line-no">740</span><span id="line-740">     * If nothing has explicitly been set, then return dflt.</span>
<span class="source-line-no">741</span><span id="line-741">     */</span>
<span class="source-line-no">742</span><span id="line-742">    private boolean getBooleanConfiguration(final String key, final boolean dflt) {</span>
<span class="source-line-no">743</span><span id="line-743">        final String val = getConfigurationValue(key);</span>
<span class="source-line-no">744</span><span id="line-744">        if (val == null) {</span>
<span class="source-line-no">745</span><span id="line-745">            return dflt;</span>
<span class="source-line-no">746</span><span id="line-746">        }</span>
<span class="source-line-no">747</span><span id="line-747">        return Boolean.parseBoolean(val);</span>
<span class="source-line-no">748</span><span id="line-748">    }</span>
<span class="source-line-no">749</span><span id="line-749"></span>
<span class="source-line-no">750</span><span id="line-750">    /**</span>
<span class="source-line-no">751</span><span id="line-751">     * Attempt to find an attribute (see method setAttribute) or a</span>
<span class="source-line-no">752</span><span id="line-752">     * system property with the provided name and return its value.</span>
<span class="source-line-no">753</span><span id="line-753">     * &lt;p&gt;</span>
<span class="source-line-no">754</span><span id="line-754">     * The attributes associated with this object are checked before</span>
<span class="source-line-no">755</span><span id="line-755">     * system properties in case someone has explicitly called setAttribute,</span>
<span class="source-line-no">756</span><span id="line-756">     * or a configuration property has been set in a commons-logging.properties</span>
<span class="source-line-no">757</span><span id="line-757">     * file.</span>
<span class="source-line-no">758</span><span id="line-758">     *</span>
<span class="source-line-no">759</span><span id="line-759">     * @return the value associated with the property, or null.</span>
<span class="source-line-no">760</span><span id="line-760">     */</span>
<span class="source-line-no">761</span><span id="line-761">    private String getConfigurationValue(final String property) {</span>
<span class="source-line-no">762</span><span id="line-762">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">763</span><span id="line-763">            logDiagnostic("[ENV] Trying to get configuration for item " + property);</span>
<span class="source-line-no">764</span><span id="line-764">        }</span>
<span class="source-line-no">765</span><span id="line-765"></span>
<span class="source-line-no">766</span><span id="line-766">        final Object valueObj =  getAttribute(property);</span>
<span class="source-line-no">767</span><span id="line-767">        if (valueObj != null) {</span>
<span class="source-line-no">768</span><span id="line-768">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">769</span><span id="line-769">                logDiagnostic("[ENV] Found LogFactory attribute [" + valueObj + "] for " + property);</span>
<span class="source-line-no">770</span><span id="line-770">            }</span>
<span class="source-line-no">771</span><span id="line-771">            return valueObj.toString();</span>
<span class="source-line-no">772</span><span id="line-772">        }</span>
<span class="source-line-no">773</span><span id="line-773"></span>
<span class="source-line-no">774</span><span id="line-774">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">775</span><span id="line-775">            logDiagnostic("[ENV] No LogFactory attribute found for " + property);</span>
<span class="source-line-no">776</span><span id="line-776">        }</span>
<span class="source-line-no">777</span><span id="line-777"></span>
<span class="source-line-no">778</span><span id="line-778">        try {</span>
<span class="source-line-no">779</span><span id="line-779">            // warning: minor security hole here, in that we potentially read a system</span>
<span class="source-line-no">780</span><span id="line-780">            // property that the caller cannot, then output it in readable form as a</span>
<span class="source-line-no">781</span><span id="line-781">            // diagnostic message. However it's only ever JCL-specific properties</span>
<span class="source-line-no">782</span><span id="line-782">            // involved here, so the harm is truly trivial.</span>
<span class="source-line-no">783</span><span id="line-783">            final String value = getSystemProperty(property, null);</span>
<span class="source-line-no">784</span><span id="line-784">            if (value != null) {</span>
<span class="source-line-no">785</span><span id="line-785">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">786</span><span id="line-786">                    logDiagnostic("[ENV] Found system property [" + value + "] for " + property);</span>
<span class="source-line-no">787</span><span id="line-787">                }</span>
<span class="source-line-no">788</span><span id="line-788">                return value;</span>
<span class="source-line-no">789</span><span id="line-789">            }</span>
<span class="source-line-no">790</span><span id="line-790"></span>
<span class="source-line-no">791</span><span id="line-791">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">792</span><span id="line-792">                logDiagnostic("[ENV] No system property found for property " + property);</span>
<span class="source-line-no">793</span><span id="line-793">            }</span>
<span class="source-line-no">794</span><span id="line-794">        } catch (final SecurityException e) {</span>
<span class="source-line-no">795</span><span id="line-795">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">796</span><span id="line-796">                logDiagnostic("[ENV] Security prevented reading system property " + property);</span>
<span class="source-line-no">797</span><span id="line-797">            }</span>
<span class="source-line-no">798</span><span id="line-798">        }</span>
<span class="source-line-no">799</span><span id="line-799"></span>
<span class="source-line-no">800</span><span id="line-800">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">801</span><span id="line-801">            logDiagnostic("[ENV] No configuration defined for item " + property);</span>
<span class="source-line-no">802</span><span id="line-802">        }</span>
<span class="source-line-no">803</span><span id="line-803"></span>
<span class="source-line-no">804</span><span id="line-804">        return null;</span>
<span class="source-line-no">805</span><span id="line-805">    }</span>
<span class="source-line-no">806</span><span id="line-806"></span>
<span class="source-line-no">807</span><span id="line-807">    /**</span>
<span class="source-line-no">808</span><span id="line-808">     * Convenience method to derive a name from the specified class and</span>
<span class="source-line-no">809</span><span id="line-809">     * call {@code getInstance(String)} with it.</span>
<span class="source-line-no">810</span><span id="line-810">     *</span>
<span class="source-line-no">811</span><span id="line-811">     * @param clazz Class for which a suitable Log name will be derived</span>
<span class="source-line-no">812</span><span id="line-812">     *</span>
<span class="source-line-no">813</span><span id="line-813">     * @throws LogConfigurationException if a suitable {@code Log}</span>
<span class="source-line-no">814</span><span id="line-814">     *  instance cannot be returned</span>
<span class="source-line-no">815</span><span id="line-815">     */</span>
<span class="source-line-no">816</span><span id="line-816">    @Override</span>
<span class="source-line-no">817</span><span id="line-817">    public Log getInstance(final Class&lt;?&gt; clazz) throws LogConfigurationException {</span>
<span class="source-line-no">818</span><span id="line-818">        return getInstance(clazz.getName());</span>
<span class="source-line-no">819</span><span id="line-819">    }</span>
<span class="source-line-no">820</span><span id="line-820"></span>
<span class="source-line-no">821</span><span id="line-821">    /**</span>
<span class="source-line-no">822</span><span id="line-822">     * &lt;p&gt;Construct (if necessary) and return a {@code Log} instance,</span>
<span class="source-line-no">823</span><span id="line-823">     * using the factory's current set of configuration attributes.&lt;/p&gt;</span>
<span class="source-line-no">824</span><span id="line-824">     *</span>
<span class="source-line-no">825</span><span id="line-825">     * &lt;p&gt;&lt;strong&gt;NOTE&lt;/strong&gt; - Depending upon the implementation of</span>
<span class="source-line-no">826</span><span id="line-826">     * the {@code LogFactory} you are using, the {@code Log}</span>
<span class="source-line-no">827</span><span id="line-827">     * instance you are returned may or may not be local to the current</span>
<span class="source-line-no">828</span><span id="line-828">     * application, and may or may not be returned again on a subsequent</span>
<span class="source-line-no">829</span><span id="line-829">     * call with the same name argument.&lt;/p&gt;</span>
<span class="source-line-no">830</span><span id="line-830">     *</span>
<span class="source-line-no">831</span><span id="line-831">     * @param name Logical name of the {@code Log} instance to be</span>
<span class="source-line-no">832</span><span id="line-832">     *  returned (the meaning of this name is only known to the underlying</span>
<span class="source-line-no">833</span><span id="line-833">     *  logging implementation that is being wrapped)</span>
<span class="source-line-no">834</span><span id="line-834">     *</span>
<span class="source-line-no">835</span><span id="line-835">     * @throws LogConfigurationException if a suitable {@code Log}</span>
<span class="source-line-no">836</span><span id="line-836">     *  instance cannot be returned</span>
<span class="source-line-no">837</span><span id="line-837">     */</span>
<span class="source-line-no">838</span><span id="line-838">    @Override</span>
<span class="source-line-no">839</span><span id="line-839">    public Log getInstance(final String name) throws LogConfigurationException {</span>
<span class="source-line-no">840</span><span id="line-840">        return instances.computeIfAbsent(name, this::newInstance);</span>
<span class="source-line-no">841</span><span id="line-841">    }</span>
<span class="source-line-no">842</span><span id="line-842"></span>
<span class="source-line-no">843</span><span id="line-843">    /**</span>
<span class="source-line-no">844</span><span id="line-844">     * Gets the fully qualified Java class name of the {@link Log} implementation we will be using.</span>
<span class="source-line-no">845</span><span id="line-845">     *</span>
<span class="source-line-no">846</span><span id="line-846">     * @return the fully qualified Java class name of the {@link Log} implementation we will be using.</span>
<span class="source-line-no">847</span><span id="line-847">     * @deprecated Never invoked by this class; subclasses should not assume it will be.</span>
<span class="source-line-no">848</span><span id="line-848">     */</span>
<span class="source-line-no">849</span><span id="line-849">    @Deprecated</span>
<span class="source-line-no">850</span><span id="line-850">    protected String getLogClassName() {</span>
<span class="source-line-no">851</span><span id="line-851">        if (logClassName == null) {</span>
<span class="source-line-no">852</span><span id="line-852">            discoverLogImplementation(getClass().getName());</span>
<span class="source-line-no">853</span><span id="line-853">        }</span>
<span class="source-line-no">854</span><span id="line-854"></span>
<span class="source-line-no">855</span><span id="line-855">        return logClassName;</span>
<span class="source-line-no">856</span><span id="line-856">    }</span>
<span class="source-line-no">857</span><span id="line-857"></span>
<span class="source-line-no">858</span><span id="line-858">    /**</span>
<span class="source-line-no">859</span><span id="line-859">     * &lt;p&gt;</span>
<span class="source-line-no">860</span><span id="line-860">     * Gets the {@code Constructor} that can be called to instantiate new {@link org.apache.commons.logging.Log} instances.</span>
<span class="source-line-no">861</span><span id="line-861">     * &lt;/p&gt;</span>
<span class="source-line-no">862</span><span id="line-862">     *</span>
<span class="source-line-no">863</span><span id="line-863">     * &lt;p&gt;</span>
<span class="source-line-no">864</span><span id="line-864">     * &lt;strong&gt;IMPLEMENTATION NOTE&lt;/strong&gt; - Race conditions caused by calling this method from more than one thread are ignored, because the same</span>
<span class="source-line-no">865</span><span id="line-865">     * {@code Constructor} instance will ultimately be derived in all circumstances.</span>
<span class="source-line-no">866</span><span id="line-866">     * &lt;/p&gt;</span>
<span class="source-line-no">867</span><span id="line-867">     *</span>
<span class="source-line-no">868</span><span id="line-868">     * @return the {@code Constructor} that can be called to instantiate new {@link org.apache.commons.logging.Log} instances.</span>
<span class="source-line-no">869</span><span id="line-869">     *</span>
<span class="source-line-no">870</span><span id="line-870">     * @throws LogConfigurationException if a suitable constructor cannot be returned</span>
<span class="source-line-no">871</span><span id="line-871">     *</span>
<span class="source-line-no">872</span><span id="line-872">     * @deprecated Never invoked by this class; subclasses should not assume it will be.</span>
<span class="source-line-no">873</span><span id="line-873">     */</span>
<span class="source-line-no">874</span><span id="line-874">    @Deprecated</span>
<span class="source-line-no">875</span><span id="line-875">    protected Constructor&lt;?&gt; getLogConstructor()</span>
<span class="source-line-no">876</span><span id="line-876">        throws LogConfigurationException {</span>
<span class="source-line-no">877</span><span id="line-877"></span>
<span class="source-line-no">878</span><span id="line-878">        // Return the previously identified Constructor (if any)</span>
<span class="source-line-no">879</span><span id="line-879">        if (logConstructor == null) {</span>
<span class="source-line-no">880</span><span id="line-880">            discoverLogImplementation(getClass().getName());</span>
<span class="source-line-no">881</span><span id="line-881">        }</span>
<span class="source-line-no">882</span><span id="line-882"></span>
<span class="source-line-no">883</span><span id="line-883">        return logConstructor;</span>
<span class="source-line-no">884</span><span id="line-884">    }</span>
<span class="source-line-no">885</span><span id="line-885"></span>
<span class="source-line-no">886</span><span id="line-886">    //  ------------------------------------------------------ Private Methods</span>
<span class="source-line-no">887</span><span id="line-887"></span>
<span class="source-line-no">888</span><span id="line-888">    /**</span>
<span class="source-line-no">889</span><span id="line-889">     * Given two related class loaders, return the one which is a child of</span>
<span class="source-line-no">890</span><span id="line-890">     * the other.</span>
<span class="source-line-no">891</span><span id="line-891">     * &lt;p&gt;</span>
<span class="source-line-no">892</span><span id="line-892">     * @param c1 is a class loader (including the null class loader)</span>
<span class="source-line-no">893</span><span id="line-893">     * @param c2 is a class loader (including the null class loader)</span>
<span class="source-line-no">894</span><span id="line-894">     *</span>
<span class="source-line-no">895</span><span id="line-895">     * @return c1 if it has c2 as an ancestor, c2 if it has c1 as an ancestor,</span>
<span class="source-line-no">896</span><span id="line-896">     * and null if neither is an ancestor of the other.</span>
<span class="source-line-no">897</span><span id="line-897">     */</span>
<span class="source-line-no">898</span><span id="line-898">    private ClassLoader getLowestClassLoader(final ClassLoader c1, final ClassLoader c2) {</span>
<span class="source-line-no">899</span><span id="line-899">        // TODO: use AccessController when dealing with class loaders here</span>
<span class="source-line-no">900</span><span id="line-900"></span>
<span class="source-line-no">901</span><span id="line-901">        if (c1 == null) {</span>
<span class="source-line-no">902</span><span id="line-902">            return c2;</span>
<span class="source-line-no">903</span><span id="line-903">        }</span>
<span class="source-line-no">904</span><span id="line-904"></span>
<span class="source-line-no">905</span><span id="line-905">        if (c2 == null) {</span>
<span class="source-line-no">906</span><span id="line-906">            return c1;</span>
<span class="source-line-no">907</span><span id="line-907">        }</span>
<span class="source-line-no">908</span><span id="line-908"></span>
<span class="source-line-no">909</span><span id="line-909">        ClassLoader current;</span>
<span class="source-line-no">910</span><span id="line-910"></span>
<span class="source-line-no">911</span><span id="line-911">        // scan c1's ancestors to find c2</span>
<span class="source-line-no">912</span><span id="line-912">        current = c1;</span>
<span class="source-line-no">913</span><span id="line-913">        while (current != null) {</span>
<span class="source-line-no">914</span><span id="line-914">            if (current == c2) {</span>
<span class="source-line-no">915</span><span id="line-915">                return c1;</span>
<span class="source-line-no">916</span><span id="line-916">            }</span>
<span class="source-line-no">917</span><span id="line-917">            // current = current.getParent();</span>
<span class="source-line-no">918</span><span id="line-918">            current = getParentClassLoader(current);</span>
<span class="source-line-no">919</span><span id="line-919">        }</span>
<span class="source-line-no">920</span><span id="line-920"></span>
<span class="source-line-no">921</span><span id="line-921">        // scan c2's ancestors to find c1</span>
<span class="source-line-no">922</span><span id="line-922">        current = c2;</span>
<span class="source-line-no">923</span><span id="line-923">        while (current != null) {</span>
<span class="source-line-no">924</span><span id="line-924">            if (current == c1) {</span>
<span class="source-line-no">925</span><span id="line-925">                return c2;</span>
<span class="source-line-no">926</span><span id="line-926">            }</span>
<span class="source-line-no">927</span><span id="line-927">            // current = current.getParent();</span>
<span class="source-line-no">928</span><span id="line-928">            current = getParentClassLoader(current);</span>
<span class="source-line-no">929</span><span id="line-929">        }</span>
<span class="source-line-no">930</span><span id="line-930"></span>
<span class="source-line-no">931</span><span id="line-931">        return null;</span>
<span class="source-line-no">932</span><span id="line-932">    }</span>
<span class="source-line-no">933</span><span id="line-933"></span>
<span class="source-line-no">934</span><span id="line-934">    /**</span>
<span class="source-line-no">935</span><span id="line-935">     * Fetch the parent class loader of a specified class loader.</span>
<span class="source-line-no">936</span><span id="line-936">     * &lt;p&gt;</span>
<span class="source-line-no">937</span><span id="line-937">     * If a SecurityException occurs, null is returned.</span>
<span class="source-line-no">938</span><span id="line-938">     * &lt;p&gt;</span>
<span class="source-line-no">939</span><span id="line-939">     * Note that this method is non-static merely so logDiagnostic is available.</span>
<span class="source-line-no">940</span><span id="line-940">     */</span>
<span class="source-line-no">941</span><span id="line-941">    private ClassLoader getParentClassLoader(final ClassLoader cl) {</span>
<span class="source-line-no">942</span><span id="line-942">        try {</span>
<span class="source-line-no">943</span><span id="line-943">            return AccessController.doPrivileged((PrivilegedAction&lt;ClassLoader&gt;) () -&gt; cl.getParent());</span>
<span class="source-line-no">944</span><span id="line-944">        } catch (final SecurityException ex) {</span>
<span class="source-line-no">945</span><span id="line-945">            logDiagnostic("[SECURITY] Unable to obtain parent class loader");</span>
<span class="source-line-no">946</span><span id="line-946">            return null;</span>
<span class="source-line-no">947</span><span id="line-947">        }</span>
<span class="source-line-no">948</span><span id="line-948"></span>
<span class="source-line-no">949</span><span id="line-949">    }</span>
<span class="source-line-no">950</span><span id="line-950"></span>
<span class="source-line-no">951</span><span id="line-951">    /**</span>
<span class="source-line-no">952</span><span id="line-952">     * Generates an internal diagnostic logging of the discovery failure and</span>
<span class="source-line-no">953</span><span id="line-953">     * then throws a {@code LogConfigurationException} that wraps</span>
<span class="source-line-no">954</span><span id="line-954">     * the passed {@code Throwable}.</span>
<span class="source-line-no">955</span><span id="line-955">     *</span>
<span class="source-line-no">956</span><span id="line-956">     * @param logAdapterClassName is the class name of the Log implementation</span>
<span class="source-line-no">957</span><span id="line-957">     * that could not be instantiated. Cannot be {@code null}.</span>
<span class="source-line-no">958</span><span id="line-958">     * @param discoveryFlaw is the Throwable created by the class loader</span>
<span class="source-line-no">959</span><span id="line-959">     *</span>
<span class="source-line-no">960</span><span id="line-960">     * @throws LogConfigurationException    ALWAYS</span>
<span class="source-line-no">961</span><span id="line-961">     */</span>
<span class="source-line-no">962</span><span id="line-962">    private void handleFlawedDiscovery(final String logAdapterClassName,</span>
<span class="source-line-no">963</span><span id="line-963">                                       final Throwable discoveryFlaw) {</span>
<span class="source-line-no">964</span><span id="line-964"></span>
<span class="source-line-no">965</span><span id="line-965">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">966</span><span id="line-966">            logDiagnostic("Could not instantiate Log '" +</span>
<span class="source-line-no">967</span><span id="line-967">                      logAdapterClassName + "' -- " +</span>
<span class="source-line-no">968</span><span id="line-968">                      discoveryFlaw.getClass().getName() + ": " +</span>
<span class="source-line-no">969</span><span id="line-969">                      discoveryFlaw.getLocalizedMessage());</span>
<span class="source-line-no">970</span><span id="line-970"></span>
<span class="source-line-no">971</span><span id="line-971">            if (discoveryFlaw instanceof InvocationTargetException ) {</span>
<span class="source-line-no">972</span><span id="line-972">                // Ok, the lib is there but while trying to create a real underlying</span>
<span class="source-line-no">973</span><span id="line-973">                // logger something failed in the underlying lib; display info about</span>
<span class="source-line-no">974</span><span id="line-974">                // that if possible.</span>
<span class="source-line-no">975</span><span id="line-975">                final InvocationTargetException ite = (InvocationTargetException) discoveryFlaw;</span>
<span class="source-line-no">976</span><span id="line-976">                final Throwable cause = ite.getTargetException();</span>
<span class="source-line-no">977</span><span id="line-977">                if (cause != null) {</span>
<span class="source-line-no">978</span><span id="line-978">                    logDiagnostic("... InvocationTargetException: " +</span>
<span class="source-line-no">979</span><span id="line-979">                        cause.getClass().getName() + ": " +</span>
<span class="source-line-no">980</span><span id="line-980">                        cause.getLocalizedMessage());</span>
<span class="source-line-no">981</span><span id="line-981"></span>
<span class="source-line-no">982</span><span id="line-982">                    if (cause instanceof ExceptionInInitializerError) {</span>
<span class="source-line-no">983</span><span id="line-983">                        final ExceptionInInitializerError eiie = (ExceptionInInitializerError) cause;</span>
<span class="source-line-no">984</span><span id="line-984">                        final Throwable cause2 = eiie.getCause();</span>
<span class="source-line-no">985</span><span id="line-985">                        if (cause2 != null) {</span>
<span class="source-line-no">986</span><span id="line-986">                            final StringWriter sw = new StringWriter();</span>
<span class="source-line-no">987</span><span id="line-987">                            cause2.printStackTrace(new PrintWriter(sw, true));</span>
<span class="source-line-no">988</span><span id="line-988">                            logDiagnostic("... ExceptionInInitializerError: " + sw.toString());</span>
<span class="source-line-no">989</span><span id="line-989">                        }</span>
<span class="source-line-no">990</span><span id="line-990">                    }</span>
<span class="source-line-no">991</span><span id="line-991">                }</span>
<span class="source-line-no">992</span><span id="line-992">            }</span>
<span class="source-line-no">993</span><span id="line-993">        }</span>
<span class="source-line-no">994</span><span id="line-994"></span>
<span class="source-line-no">995</span><span id="line-995">        if (!allowFlawedDiscovery) {</span>
<span class="source-line-no">996</span><span id="line-996">            throw new LogConfigurationException(discoveryFlaw);</span>
<span class="source-line-no">997</span><span id="line-997">        }</span>
<span class="source-line-no">998</span><span id="line-998">    }</span>
<span class="source-line-no">999</span><span id="line-999"></span>
<span class="source-line-no">1000</span><span id="line-1000">    /**</span>
<span class="source-line-no">1001</span><span id="line-1001">     * Report a problem loading the log adapter, then either return</span>
<span class="source-line-no">1002</span><span id="line-1002">     * (if the situation is considered recoverable) or throw a</span>
<span class="source-line-no">1003</span><span id="line-1003">     * LogConfigurationException.</span>
<span class="source-line-no">1004</span><span id="line-1004">     * &lt;p&gt;</span>
<span class="source-line-no">1005</span><span id="line-1005">     * There are two possible reasons why we successfully loaded the</span>
<span class="source-line-no">1006</span><span id="line-1006">     * specified log adapter class then failed to cast it to a Log object:</span>
<span class="source-line-no">1007</span><span id="line-1007">     * &lt;ol&gt;</span>
<span class="source-line-no">1008</span><span id="line-1008">     * &lt;li&gt;the specific class just doesn't implement the Log interface</span>
<span class="source-line-no">1009</span><span id="line-1009">     *     (user screwed up), or</span>
<span class="source-line-no">1010</span><span id="line-1010">     * &lt;li&gt; the specified class has bound to a Log class loaded by some other</span>
<span class="source-line-no">1011</span><span id="line-1011">     *      class loader; Log@ClassLoaderX cannot be cast to Log@ClassLoaderY.</span>
<span class="source-line-no">1012</span><span id="line-1012">     * &lt;/ol&gt;</span>
<span class="source-line-no">1013</span><span id="line-1013">     * &lt;p&gt;</span>
<span class="source-line-no">1014</span><span id="line-1014">     * Here we try to figure out which case has occurred so we can give the</span>
<span class="source-line-no">1015</span><span id="line-1015">     * user some reasonable feedback.</span>
<span class="source-line-no">1016</span><span id="line-1016">     *</span>
<span class="source-line-no">1017</span><span id="line-1017">     * @param badClassLoader is the class loader we loaded the problem class from,</span>
<span class="source-line-no">1018</span><span id="line-1018">     * ie it is equivalent to badClass.getClassLoader().</span>
<span class="source-line-no">1019</span><span id="line-1019">     *</span>
<span class="source-line-no">1020</span><span id="line-1020">     * @param badClass is a Class object with the desired name, but which</span>
<span class="source-line-no">1021</span><span id="line-1021">     * does not implement Log correctly.</span>
<span class="source-line-no">1022</span><span id="line-1022">     *</span>
<span class="source-line-no">1023</span><span id="line-1023">     * @throws LogConfigurationException when the situation</span>
<span class="source-line-no">1024</span><span id="line-1024">     * should not be recovered from.</span>
<span class="source-line-no">1025</span><span id="line-1025">     */</span>
<span class="source-line-no">1026</span><span id="line-1026">    private void handleFlawedHierarchy(final ClassLoader badClassLoader, final Class&lt;?&gt; badClass)</span>
<span class="source-line-no">1027</span><span id="line-1027">        throws LogConfigurationException {</span>
<span class="source-line-no">1028</span><span id="line-1028"></span>
<span class="source-line-no">1029</span><span id="line-1029">        boolean implementsLog = false;</span>
<span class="source-line-no">1030</span><span id="line-1030">        final String logInterfaceName = Log.class.getName();</span>
<span class="source-line-no">1031</span><span id="line-1031">        final Class&lt;?&gt;[] interfaces = badClass.getInterfaces();</span>
<span class="source-line-no">1032</span><span id="line-1032">        for (final Class&lt;?&gt; element : interfaces) {</span>
<span class="source-line-no">1033</span><span id="line-1033">            if (logInterfaceName.equals(element.getName())) {</span>
<span class="source-line-no">1034</span><span id="line-1034">                implementsLog = true;</span>
<span class="source-line-no">1035</span><span id="line-1035">                break;</span>
<span class="source-line-no">1036</span><span id="line-1036">            }</span>
<span class="source-line-no">1037</span><span id="line-1037">        }</span>
<span class="source-line-no">1038</span><span id="line-1038"></span>
<span class="source-line-no">1039</span><span id="line-1039">        if (implementsLog) {</span>
<span class="source-line-no">1040</span><span id="line-1040">            // the class does implement an interface called Log, but</span>
<span class="source-line-no">1041</span><span id="line-1041">            // it is in the wrong class loader</span>
<span class="source-line-no">1042</span><span id="line-1042">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1043</span><span id="line-1043">                try {</span>
<span class="source-line-no">1044</span><span id="line-1044">                    final ClassLoader logInterfaceClassLoader = getClassLoader(Log.class);</span>
<span class="source-line-no">1045</span><span id="line-1045">                    logDiagnostic("Class '" + badClass.getName() + "' was found in class loader " +</span>
<span class="source-line-no">1046</span><span id="line-1046">                                  objectId(badClassLoader) + ". It is bound to a Log interface which is not" +</span>
<span class="source-line-no">1047</span><span id="line-1047">                                  " the one loaded from class loader " + objectId(logInterfaceClassLoader));</span>
<span class="source-line-no">1048</span><span id="line-1048">                } catch (final Throwable t) {</span>
<span class="source-line-no">1049</span><span id="line-1049">                    handleThrowable(t); // may re-throw t</span>
<span class="source-line-no">1050</span><span id="line-1050">                    logDiagnostic("Error while trying to output diagnostics about" + " bad class '" + badClass + "'");</span>
<span class="source-line-no">1051</span><span id="line-1051">                }</span>
<span class="source-line-no">1052</span><span id="line-1052">            }</span>
<span class="source-line-no">1053</span><span id="line-1053"></span>
<span class="source-line-no">1054</span><span id="line-1054">            if (!allowFlawedHierarchy) {</span>
<span class="source-line-no">1055</span><span id="line-1055">                final StringBuilder msg = new StringBuilder();</span>
<span class="source-line-no">1056</span><span id="line-1056">                msg.append("Terminating logging for this context ");</span>
<span class="source-line-no">1057</span><span id="line-1057">                msg.append("due to bad log hierarchy. ");</span>
<span class="source-line-no">1058</span><span id="line-1058">                msg.append("You have more than one version of '");</span>
<span class="source-line-no">1059</span><span id="line-1059">                msg.append(Log.class.getName());</span>
<span class="source-line-no">1060</span><span id="line-1060">                msg.append("' visible.");</span>
<span class="source-line-no">1061</span><span id="line-1061">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1062</span><span id="line-1062">                    logDiagnostic(msg.toString());</span>
<span class="source-line-no">1063</span><span id="line-1063">                }</span>
<span class="source-line-no">1064</span><span id="line-1064">                throw new LogConfigurationException(msg.toString());</span>
<span class="source-line-no">1065</span><span id="line-1065">            }</span>
<span class="source-line-no">1066</span><span id="line-1066"></span>
<span class="source-line-no">1067</span><span id="line-1067">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1068</span><span id="line-1068">                final StringBuilder msg = new StringBuilder();</span>
<span class="source-line-no">1069</span><span id="line-1069">                msg.append("Warning: bad log hierarchy. ");</span>
<span class="source-line-no">1070</span><span id="line-1070">                msg.append("You have more than one version of '");</span>
<span class="source-line-no">1071</span><span id="line-1071">                msg.append(Log.class.getName());</span>
<span class="source-line-no">1072</span><span id="line-1072">                msg.append("' visible.");</span>
<span class="source-line-no">1073</span><span id="line-1073">                logDiagnostic(msg.toString());</span>
<span class="source-line-no">1074</span><span id="line-1074">            }</span>
<span class="source-line-no">1075</span><span id="line-1075">        } else {</span>
<span class="source-line-no">1076</span><span id="line-1076">            // this is just a bad adapter class</span>
<span class="source-line-no">1077</span><span id="line-1077">            if (!allowFlawedDiscovery) {</span>
<span class="source-line-no">1078</span><span id="line-1078">                final StringBuilder msg = new StringBuilder();</span>
<span class="source-line-no">1079</span><span id="line-1079">                msg.append("Terminating logging for this context. ");</span>
<span class="source-line-no">1080</span><span id="line-1080">                msg.append("Log class '");</span>
<span class="source-line-no">1081</span><span id="line-1081">                msg.append(badClass.getName());</span>
<span class="source-line-no">1082</span><span id="line-1082">                msg.append("' does not implement the Log interface.");</span>
<span class="source-line-no">1083</span><span id="line-1083">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1084</span><span id="line-1084">                    logDiagnostic(msg.toString());</span>
<span class="source-line-no">1085</span><span id="line-1085">                }</span>
<span class="source-line-no">1086</span><span id="line-1086"></span>
<span class="source-line-no">1087</span><span id="line-1087">                throw new LogConfigurationException(msg.toString());</span>
<span class="source-line-no">1088</span><span id="line-1088">            }</span>
<span class="source-line-no">1089</span><span id="line-1089"></span>
<span class="source-line-no">1090</span><span id="line-1090">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1091</span><span id="line-1091">                final StringBuilder msg = new StringBuilder();</span>
<span class="source-line-no">1092</span><span id="line-1092">                msg.append("[WARNING] Log class '");</span>
<span class="source-line-no">1093</span><span id="line-1093">                msg.append(badClass.getName());</span>
<span class="source-line-no">1094</span><span id="line-1094">                msg.append("' does not implement the Log interface.");</span>
<span class="source-line-no">1095</span><span id="line-1095">                logDiagnostic(msg.toString());</span>
<span class="source-line-no">1096</span><span id="line-1096">            }</span>
<span class="source-line-no">1097</span><span id="line-1097">        }</span>
<span class="source-line-no">1098</span><span id="line-1098">    }</span>
<span class="source-line-no">1099</span><span id="line-1099"></span>
<span class="source-line-no">1100</span><span id="line-1100">    /**</span>
<span class="source-line-no">1101</span><span id="line-1101">     * Appends message if the given name is similar to the candidate.</span>
<span class="source-line-no">1102</span><span id="line-1102">     * @param messageBuffer {@code StringBuffer} the message should be appended to,</span>
<span class="source-line-no">1103</span><span id="line-1103">     * not null</span>
<span class="source-line-no">1104</span><span id="line-1104">     * @param name the (trimmed) name to be test against the candidate, not null</span>
<span class="source-line-no">1105</span><span id="line-1105">     * @param candidate the candidate name (not null)</span>
<span class="source-line-no">1106</span><span id="line-1106">     */</span>
<span class="source-line-no">1107</span><span id="line-1107">    private void informUponSimilarName(final StringBuilder messageBuffer, final String name,</span>
<span class="source-line-no">1108</span><span id="line-1108">            final String candidate) {</span>
<span class="source-line-no">1109</span><span id="line-1109">        if (name.equals(candidate)) {</span>
<span class="source-line-no">1110</span><span id="line-1110">            // Don't suggest a name that is exactly the same as the one the</span>
<span class="source-line-no">1111</span><span id="line-1111">            // user tried...</span>
<span class="source-line-no">1112</span><span id="line-1112">            return;</span>
<span class="source-line-no">1113</span><span id="line-1113">        }</span>
<span class="source-line-no">1114</span><span id="line-1114"></span>
<span class="source-line-no">1115</span><span id="line-1115">        // If the user provides a name that is in the right package, and gets</span>
<span class="source-line-no">1116</span><span id="line-1116">        // the first 5 characters of the adapter class right (ignoring case),</span>
<span class="source-line-no">1117</span><span id="line-1117">        // then suggest the candidate adapter class name.</span>
<span class="source-line-no">1118</span><span id="line-1118">        if (name.regionMatches(true, 0, candidate, 0, PKG_LEN + 5)) {</span>
<span class="source-line-no">1119</span><span id="line-1119">            messageBuffer.append(" Did you mean '");</span>
<span class="source-line-no">1120</span><span id="line-1120">            messageBuffer.append(candidate);</span>
<span class="source-line-no">1121</span><span id="line-1121">            messageBuffer.append("'?");</span>
<span class="source-line-no">1122</span><span id="line-1122">        }</span>
<span class="source-line-no">1123</span><span id="line-1123">    }</span>
<span class="source-line-no">1124</span><span id="line-1124"></span>
<span class="source-line-no">1125</span><span id="line-1125">    /**</span>
<span class="source-line-no">1126</span><span id="line-1126">     * Initialize a number of variables that control the behavior of this</span>
<span class="source-line-no">1127</span><span id="line-1127">     * class and that can be tweaked by the user. This is done when the first</span>
<span class="source-line-no">1128</span><span id="line-1128">     * logger is created, not in the constructor of this class, because we</span>
<span class="source-line-no">1129</span><span id="line-1129">     * need to give the user a chance to call method setAttribute in order to</span>
<span class="source-line-no">1130</span><span id="line-1130">     * configure this object.</span>
<span class="source-line-no">1131</span><span id="line-1131">     */</span>
<span class="source-line-no">1132</span><span id="line-1132">    private void initConfiguration() {</span>
<span class="source-line-no">1133</span><span id="line-1133">        allowFlawedContext = getBooleanConfiguration(ALLOW_FLAWED_CONTEXT_PROPERTY, true);</span>
<span class="source-line-no">1134</span><span id="line-1134">        allowFlawedDiscovery = getBooleanConfiguration(ALLOW_FLAWED_DISCOVERY_PROPERTY, true);</span>
<span class="source-line-no">1135</span><span id="line-1135">        allowFlawedHierarchy = getBooleanConfiguration(ALLOW_FLAWED_HIERARCHY_PROPERTY, true);</span>
<span class="source-line-no">1136</span><span id="line-1136">    }</span>
<span class="source-line-no">1137</span><span id="line-1137"></span>
<span class="source-line-no">1138</span><span id="line-1138">    /**</span>
<span class="source-line-no">1139</span><span id="line-1139">     * Calculate and cache a string that uniquely identifies this instance,</span>
<span class="source-line-no">1140</span><span id="line-1140">     * including which class loader the object was loaded from.</span>
<span class="source-line-no">1141</span><span id="line-1141">     * &lt;p&gt;</span>
<span class="source-line-no">1142</span><span id="line-1142">     * This string will later be prefixed to each "internal logging" message</span>
<span class="source-line-no">1143</span><span id="line-1143">     * emitted, so that users can clearly see any unexpected behavior.</span>
<span class="source-line-no">1144</span><span id="line-1144">     * &lt;p&gt;</span>
<span class="source-line-no">1145</span><span id="line-1145">     * Note that this method does not detect whether internal logging is</span>
<span class="source-line-no">1146</span><span id="line-1146">     * enabled or not, nor where to output stuff if it is; that is all</span>
<span class="source-line-no">1147</span><span id="line-1147">     * handled by the parent LogFactory class. This method just computes</span>
<span class="source-line-no">1148</span><span id="line-1148">     * its own unique prefix for log messages.</span>
<span class="source-line-no">1149</span><span id="line-1149">     */</span>
<span class="source-line-no">1150</span><span id="line-1150">    private void initDiagnostics() {</span>
<span class="source-line-no">1151</span><span id="line-1151">        // It would be nice to include an identifier of the context class loader</span>
<span class="source-line-no">1152</span><span id="line-1152">        // that this LogFactoryImpl object is responsible for. However that</span>
<span class="source-line-no">1153</span><span id="line-1153">        // isn't possible as that information isn't available. It is possible</span>
<span class="source-line-no">1154</span><span id="line-1154">        // to figure this out by looking at the logging from LogFactory to</span>
<span class="source-line-no">1155</span><span id="line-1155">        // see the context &amp; impl ids from when this object was instantiated,</span>
<span class="source-line-no">1156</span><span id="line-1156">        // in order to link the impl id output as this object's prefix back to</span>
<span class="source-line-no">1157</span><span id="line-1157">        // the context it is intended to manage.</span>
<span class="source-line-no">1158</span><span id="line-1158">        // Note that this prefix should be kept consistent with that</span>
<span class="source-line-no">1159</span><span id="line-1159">        // in LogFactory.</span>
<span class="source-line-no">1160</span><span id="line-1160">        @SuppressWarnings("unchecked")</span>
<span class="source-line-no">1161</span><span id="line-1161">        final Class&lt;LogFactoryImpl&gt; clazz = (Class&lt;LogFactoryImpl&gt;) this.getClass();</span>
<span class="source-line-no">1162</span><span id="line-1162">        final ClassLoader classLoader = getClassLoader(clazz);</span>
<span class="source-line-no">1163</span><span id="line-1163">        String classLoaderName;</span>
<span class="source-line-no">1164</span><span id="line-1164">        try {</span>
<span class="source-line-no">1165</span><span id="line-1165">            if (classLoader == null) {</span>
<span class="source-line-no">1166</span><span id="line-1166">                classLoaderName = "BOOTLOADER";</span>
<span class="source-line-no">1167</span><span id="line-1167">            } else {</span>
<span class="source-line-no">1168</span><span id="line-1168">                classLoaderName = objectId(classLoader);</span>
<span class="source-line-no">1169</span><span id="line-1169">            }</span>
<span class="source-line-no">1170</span><span id="line-1170">        } catch (final SecurityException e) {</span>
<span class="source-line-no">1171</span><span id="line-1171">            classLoaderName = "UNKNOWN";</span>
<span class="source-line-no">1172</span><span id="line-1172">        }</span>
<span class="source-line-no">1173</span><span id="line-1173">        diagnosticPrefix = "[LogFactoryImpl@" + System.identityHashCode(this) + " from " + classLoaderName + "] ";</span>
<span class="source-line-no">1174</span><span id="line-1174">    }</span>
<span class="source-line-no">1175</span><span id="line-1175"></span>
<span class="source-line-no">1176</span><span id="line-1176">    /**</span>
<span class="source-line-no">1177</span><span id="line-1177">     * Tests whether &lt;em&gt;JDK 1.3 with Lumberjack&lt;/em&gt; logging available.</span>
<span class="source-line-no">1178</span><span id="line-1178">     *</span>
<span class="source-line-no">1179</span><span id="line-1179">     * @return whether &lt;em&gt;JDK 1.3 with Lumberjack&lt;/em&gt; logging available.</span>
<span class="source-line-no">1180</span><span id="line-1180">     * @deprecated Never invoked by this class; subclasses should not assume it will be.</span>
<span class="source-line-no">1181</span><span id="line-1181">     */</span>
<span class="source-line-no">1182</span><span id="line-1182">    @Deprecated</span>
<span class="source-line-no">1183</span><span id="line-1183">    protected boolean isJdk13LumberjackAvailable() {</span>
<span class="source-line-no">1184</span><span id="line-1184">        return isLogLibraryAvailable(</span>
<span class="source-line-no">1185</span><span id="line-1185">                "Jdk13Lumberjack",</span>
<span class="source-line-no">1186</span><span id="line-1186">                "org.apache.commons.logging.impl.Jdk13LumberjackLogger");</span>
<span class="source-line-no">1187</span><span id="line-1187">    }</span>
<span class="source-line-no">1188</span><span id="line-1188"></span>
<span class="source-line-no">1189</span><span id="line-1189">    /**</span>
<span class="source-line-no">1190</span><span id="line-1190">     * Tests {@code true} whether &lt;em&gt;JDK 1.4 or later&lt;/em&gt; logging is available. Also checks that the {@code Throwable} class supports {@code getStackTrace()},</span>
<span class="source-line-no">1191</span><span id="line-1191">     * which is required by Jdk14Logger.</span>
<span class="source-line-no">1192</span><span id="line-1192">     *</span>
<span class="source-line-no">1193</span><span id="line-1193">     * @return Whether &lt;em&gt;JDK 1.4 or later&lt;/em&gt; logging is available.</span>
<span class="source-line-no">1194</span><span id="line-1194">     *</span>
<span class="source-line-no">1195</span><span id="line-1195">     * @deprecated Never invoked by this class; subclasses should not assume it will be.</span>
<span class="source-line-no">1196</span><span id="line-1196">     */</span>
<span class="source-line-no">1197</span><span id="line-1197">    @Deprecated</span>
<span class="source-line-no">1198</span><span id="line-1198">    protected boolean isJdk14Available() {</span>
<span class="source-line-no">1199</span><span id="line-1199">        return isLogLibraryAvailable("Jdk14", "org.apache.commons.logging.impl.Jdk14Logger");</span>
<span class="source-line-no">1200</span><span id="line-1200">    }</span>
<span class="source-line-no">1201</span><span id="line-1201"></span>
<span class="source-line-no">1202</span><span id="line-1202">    /**</span>
<span class="source-line-no">1203</span><span id="line-1203">     * Tests whether a &lt;em&gt;Log4J&lt;/em&gt; implementation available.</span>
<span class="source-line-no">1204</span><span id="line-1204">     *</span>
<span class="source-line-no">1205</span><span id="line-1205">     * @return whether a &lt;em&gt;Log4J&lt;/em&gt; implementation available.</span>
<span class="source-line-no">1206</span><span id="line-1206">     *</span>
<span class="source-line-no">1207</span><span id="line-1207">     * @deprecated Never invoked by this class; subclasses should not assume it will be.</span>
<span class="source-line-no">1208</span><span id="line-1208">     */</span>
<span class="source-line-no">1209</span><span id="line-1209">    @Deprecated</span>
<span class="source-line-no">1210</span><span id="line-1210">    protected boolean isLog4JAvailable() {</span>
<span class="source-line-no">1211</span><span id="line-1211">        return isLogLibraryAvailable("Log4J", LOGGING_IMPL_LOG4J_LOGGER);</span>
<span class="source-line-no">1212</span><span id="line-1212">    }</span>
<span class="source-line-no">1213</span><span id="line-1213"></span>
<span class="source-line-no">1214</span><span id="line-1214">    /**</span>
<span class="source-line-no">1215</span><span id="line-1215">     * Utility method to check whether a particular logging library is</span>
<span class="source-line-no">1216</span><span id="line-1216">     * present and available for use. Note that this does &lt;i&gt;not&lt;/i&gt;</span>
<span class="source-line-no">1217</span><span id="line-1217">     * affect the future behavior of this class.</span>
<span class="source-line-no">1218</span><span id="line-1218">     */</span>
<span class="source-line-no">1219</span><span id="line-1219">    private boolean isLogLibraryAvailable(final String name, final String className) {</span>
<span class="source-line-no">1220</span><span id="line-1220">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1221</span><span id="line-1221">            logDiagnostic("Checking for '" + name + "'.");</span>
<span class="source-line-no">1222</span><span id="line-1222">        }</span>
<span class="source-line-no">1223</span><span id="line-1223">        try {</span>
<span class="source-line-no">1224</span><span id="line-1224">            final Log log = createLogFromClass(</span>
<span class="source-line-no">1225</span><span id="line-1225">                        className,</span>
<span class="source-line-no">1226</span><span id="line-1226">                        this.getClass().getName(), // dummy category</span>
<span class="source-line-no">1227</span><span id="line-1227">                        false);</span>
<span class="source-line-no">1228</span><span id="line-1228"></span>
<span class="source-line-no">1229</span><span id="line-1229">            if (log == null) {</span>
<span class="source-line-no">1230</span><span id="line-1230">                if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1231</span><span id="line-1231">                    logDiagnostic("Did not find '" + name + "'.");</span>
<span class="source-line-no">1232</span><span id="line-1232">                }</span>
<span class="source-line-no">1233</span><span id="line-1233">                return false;</span>
<span class="source-line-no">1234</span><span id="line-1234">            }</span>
<span class="source-line-no">1235</span><span id="line-1235">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1236</span><span id="line-1236">                logDiagnostic("Found '" + name + "'.");</span>
<span class="source-line-no">1237</span><span id="line-1237">            }</span>
<span class="source-line-no">1238</span><span id="line-1238">            return true;</span>
<span class="source-line-no">1239</span><span id="line-1239">        } catch (final LogConfigurationException e) {</span>
<span class="source-line-no">1240</span><span id="line-1240">            if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1241</span><span id="line-1241">                logDiagnostic("Logging system '" + name + "' is available but not useable.");</span>
<span class="source-line-no">1242</span><span id="line-1242">            }</span>
<span class="source-line-no">1243</span><span id="line-1243">            return false;</span>
<span class="source-line-no">1244</span><span id="line-1244">        }</span>
<span class="source-line-no">1245</span><span id="line-1245">    }</span>
<span class="source-line-no">1246</span><span id="line-1246"></span>
<span class="source-line-no">1247</span><span id="line-1247">    /**</span>
<span class="source-line-no">1248</span><span id="line-1248">     * Output a diagnostic message to a user-specified destination (if the</span>
<span class="source-line-no">1249</span><span id="line-1249">     * user has enabled diagnostic logging).</span>
<span class="source-line-no">1250</span><span id="line-1250">     *</span>
<span class="source-line-no">1251</span><span id="line-1251">     * @param msg diagnostic message</span>
<span class="source-line-no">1252</span><span id="line-1252">     * @since 1.1</span>
<span class="source-line-no">1253</span><span id="line-1253">     */</span>
<span class="source-line-no">1254</span><span id="line-1254">    protected void logDiagnostic(final String msg) {</span>
<span class="source-line-no">1255</span><span id="line-1255">        if (isDiagnosticsEnabled()) {</span>
<span class="source-line-no">1256</span><span id="line-1256">            logRawDiagnostic(diagnosticPrefix + msg);</span>
<span class="source-line-no">1257</span><span id="line-1257">        }</span>
<span class="source-line-no">1258</span><span id="line-1258">    }</span>
<span class="source-line-no">1259</span><span id="line-1259"></span>
<span class="source-line-no">1260</span><span id="line-1260">    /**</span>
<span class="source-line-no">1261</span><span id="line-1261">     * Create and return a new {@link org.apache.commons.logging.Log} instance for the specified name.</span>
<span class="source-line-no">1262</span><span id="line-1262">     *</span>
<span class="source-line-no">1263</span><span id="line-1263">     * @param name Name of the new logger</span>
<span class="source-line-no">1264</span><span id="line-1264">     * @return a new {@link org.apache.commons.logging.Log}</span>
<span class="source-line-no">1265</span><span id="line-1265">     *</span>
<span class="source-line-no">1266</span><span id="line-1266">     * @throws LogConfigurationException if a new instance cannot be created</span>
<span class="source-line-no">1267</span><span id="line-1267">     */</span>
<span class="source-line-no">1268</span><span id="line-1268">    protected Log newInstance(final String name) throws LogConfigurationException {</span>
<span class="source-line-no">1269</span><span id="line-1269">        Log instance;</span>
<span class="source-line-no">1270</span><span id="line-1270">        try {</span>
<span class="source-line-no">1271</span><span id="line-1271">            if (logConstructor == null) {</span>
<span class="source-line-no">1272</span><span id="line-1272">                instance = discoverLogImplementation(name);</span>
<span class="source-line-no">1273</span><span id="line-1273">            }</span>
<span class="source-line-no">1274</span><span id="line-1274">            else {</span>
<span class="source-line-no">1275</span><span id="line-1275">                final Object[] params = { name };</span>
<span class="source-line-no">1276</span><span id="line-1276">                instance = (Log) logConstructor.newInstance(params);</span>
<span class="source-line-no">1277</span><span id="line-1277">            }</span>
<span class="source-line-no">1278</span><span id="line-1278"></span>
<span class="source-line-no">1279</span><span id="line-1279">            if (logMethod != null) {</span>
<span class="source-line-no">1280</span><span id="line-1280">                final Object[] params = { this };</span>
<span class="source-line-no">1281</span><span id="line-1281">                logMethod.invoke(instance, params);</span>
<span class="source-line-no">1282</span><span id="line-1282">            }</span>
<span class="source-line-no">1283</span><span id="line-1283"></span>
<span class="source-line-no">1284</span><span id="line-1284">            return instance;</span>
<span class="source-line-no">1285</span><span id="line-1285"></span>
<span class="source-line-no">1286</span><span id="line-1286">        } catch (final LogConfigurationException lce) {</span>
<span class="source-line-no">1287</span><span id="line-1287"></span>
<span class="source-line-no">1288</span><span id="line-1288">            // this type of exception means there was a problem in discovery</span>
<span class="source-line-no">1289</span><span id="line-1289">            // and we've already output diagnostics about the issue, etc.;</span>
<span class="source-line-no">1290</span><span id="line-1290">            // just pass it on</span>
<span class="source-line-no">1291</span><span id="line-1291">            throw lce;</span>
<span class="source-line-no">1292</span><span id="line-1292"></span>
<span class="source-line-no">1293</span><span id="line-1293">        } catch (final InvocationTargetException e) {</span>
<span class="source-line-no">1294</span><span id="line-1294">            // A problem occurred invoking the Constructor or Method</span>
<span class="source-line-no">1295</span><span id="line-1295">            // previously discovered</span>
<span class="source-line-no">1296</span><span id="line-1296">            final Throwable c = e.getTargetException();</span>
<span class="source-line-no">1297</span><span id="line-1297">            throw new LogConfigurationException(c == null ? e : c);</span>
<span class="source-line-no">1298</span><span id="line-1298">        } catch (final Throwable t) {</span>
<span class="source-line-no">1299</span><span id="line-1299">            handleThrowable(t); // may re-throw t</span>
<span class="source-line-no">1300</span><span id="line-1300">            // A problem occurred invoking the Constructor or Method</span>
<span class="source-line-no">1301</span><span id="line-1301">            // previously discovered</span>
<span class="source-line-no">1302</span><span id="line-1302">            throw new LogConfigurationException(t);</span>
<span class="source-line-no">1303</span><span id="line-1303">        }</span>
<span class="source-line-no">1304</span><span id="line-1304">    }</span>
<span class="source-line-no">1305</span><span id="line-1305"></span>
<span class="source-line-no">1306</span><span id="line-1306">    /**</span>
<span class="source-line-no">1307</span><span id="line-1307">     * Release any internal references to previously created</span>
<span class="source-line-no">1308</span><span id="line-1308">     * {@link org.apache.commons.logging.Log}</span>
<span class="source-line-no">1309</span><span id="line-1309">     * instances returned by this factory.  This is useful in environments</span>
<span class="source-line-no">1310</span><span id="line-1310">     * like servlet containers, which implement application reloading by</span>
<span class="source-line-no">1311</span><span id="line-1311">     * throwing away a ClassLoader.  Dangling references to objects in that</span>
<span class="source-line-no">1312</span><span id="line-1312">     * class loader would prevent garbage collection.</span>
<span class="source-line-no">1313</span><span id="line-1313">     */</span>
<span class="source-line-no">1314</span><span id="line-1314">    @Override</span>
<span class="source-line-no">1315</span><span id="line-1315">    public void release() {</span>
<span class="source-line-no">1316</span><span id="line-1316"></span>
<span class="source-line-no">1317</span><span id="line-1317">        logDiagnostic("Releasing all known loggers");</span>
<span class="source-line-no">1318</span><span id="line-1318">        instances.clear();</span>
<span class="source-line-no">1319</span><span id="line-1319">    }</span>
<span class="source-line-no">1320</span><span id="line-1320"></span>
<span class="source-line-no">1321</span><span id="line-1321">    /**</span>
<span class="source-line-no">1322</span><span id="line-1322">     * Remove any configuration attribute associated with the specified name.</span>
<span class="source-line-no">1323</span><span id="line-1323">     * If there is no such attribute, no action is taken.</span>
<span class="source-line-no">1324</span><span id="line-1324">     *</span>
<span class="source-line-no">1325</span><span id="line-1325">     * @param name Name of the attribute to remove</span>
<span class="source-line-no">1326</span><span id="line-1326">     */</span>
<span class="source-line-no">1327</span><span id="line-1327">    @Override</span>
<span class="source-line-no">1328</span><span id="line-1328">    public void removeAttribute(final String name) {</span>
<span class="source-line-no">1329</span><span id="line-1329">        attributes.remove(name);</span>
<span class="source-line-no">1330</span><span id="line-1330">    }</span>
<span class="source-line-no">1331</span><span id="line-1331"></span>
<span class="source-line-no">1332</span><span id="line-1332">    /**</span>
<span class="source-line-no">1333</span><span id="line-1333">     * Sets the configuration attribute with the specified name.  Calling</span>
<span class="source-line-no">1334</span><span id="line-1334">     * this with a {@code null} value is equivalent to calling</span>
<span class="source-line-no">1335</span><span id="line-1335">     * {@code removeAttribute(name)}.</span>
<span class="source-line-no">1336</span><span id="line-1336">     * &lt;p&gt;</span>
<span class="source-line-no">1337</span><span id="line-1337">     * This method can be used to set logging configuration programmatically</span>
<span class="source-line-no">1338</span><span id="line-1338">     * rather than via system properties. It can also be used in code running</span>
<span class="source-line-no">1339</span><span id="line-1339">     * within a container (such as a webapp) to configure behavior on a</span>
<span class="source-line-no">1340</span><span id="line-1340">     * per-component level instead of globally as system properties would do.</span>
<span class="source-line-no">1341</span><span id="line-1341">     * To use this method instead of a system property, call</span>
<span class="source-line-no">1342</span><span id="line-1342">     * &lt;pre&gt;</span>
<span class="source-line-no">1343</span><span id="line-1343">     * LogFactory.getFactory().setAttribute(...)</span>
<span class="source-line-no">1344</span><span id="line-1344">     * &lt;/pre&gt;</span>
<span class="source-line-no">1345</span><span id="line-1345">     * This must be done before the first Log object is created; configuration</span>
<span class="source-line-no">1346</span><span id="line-1346">     * changes after that point will be ignored.</span>
<span class="source-line-no">1347</span><span id="line-1347">     * &lt;p&gt;</span>
<span class="source-line-no">1348</span><span id="line-1348">     * This method is also called automatically if LogFactory detects a</span>
<span class="source-line-no">1349</span><span id="line-1349">     * commons-logging.properties file; every entry in that file is set</span>
<span class="source-line-no">1350</span><span id="line-1350">     * automatically as an attribute here.</span>
<span class="source-line-no">1351</span><span id="line-1351">     *</span>
<span class="source-line-no">1352</span><span id="line-1352">     * @param name Name of the attribute to set</span>
<span class="source-line-no">1353</span><span id="line-1353">     * @param value Value of the attribute to set, or {@code null}</span>
<span class="source-line-no">1354</span><span id="line-1354">     *  to remove any setting for this attribute</span>
<span class="source-line-no">1355</span><span id="line-1355">     */</span>
<span class="source-line-no">1356</span><span id="line-1356">    @Override</span>
<span class="source-line-no">1357</span><span id="line-1357">    public void setAttribute(final String name, final Object value) {</span>
<span class="source-line-no">1358</span><span id="line-1358">        if (logConstructor != null) {</span>
<span class="source-line-no">1359</span><span id="line-1359">            logDiagnostic("setAttribute: call too late; configuration already performed.");</span>
<span class="source-line-no">1360</span><span id="line-1360">        }</span>
<span class="source-line-no">1361</span><span id="line-1361"></span>
<span class="source-line-no">1362</span><span id="line-1362">        if (value == null) {</span>
<span class="source-line-no">1363</span><span id="line-1363">            attributes.remove(name);</span>
<span class="source-line-no">1364</span><span id="line-1364">        } else {</span>
<span class="source-line-no">1365</span><span id="line-1365">            attributes.put(name, value);</span>
<span class="source-line-no">1366</span><span id="line-1366">        }</span>
<span class="source-line-no">1367</span><span id="line-1367"></span>
<span class="source-line-no">1368</span><span id="line-1368">        if (name.equals(TCCL_KEY)) {</span>
<span class="source-line-no">1369</span><span id="line-1369">            useTCCL = value != null &amp;&amp; Boolean.parseBoolean(value.toString());</span>
<span class="source-line-no">1370</span><span id="line-1370">        }</span>
<span class="source-line-no">1371</span><span id="line-1371">    }</span>
<span class="source-line-no">1372</span><span id="line-1372">}</span>




























































</pre>
</div>
</main>
</body>
</html>
